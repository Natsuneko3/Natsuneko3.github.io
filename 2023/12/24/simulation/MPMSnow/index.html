<!DOCTYPE html><html lang="ch"><head><link rel="stylesheet" href="/css/bilicard.css"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="夏猫" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="夏猫" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="夏猫" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="模拟,文章"><link rel="canonical" href="http://example.com/2023/12/24/simulation/MPMSnow/"><meta name="description" content="# MPM 雪、海绵 # 简介 在上一篇文章写完了 MLS-MPM 对于水的模型后，想着记录下其他材质的模拟方法。其实这一篇对现在的项目来说没什么卵用，但打算还是记录下，因为我知道未来在游戏肯定会用上实时模拟，现在所学的没用的东西都是为了未来做铺垫。那么这一篇就写其他弹性材质的其他数学模型。这就是用 MPM 的好处。就是对于其他弹性材料我们只需要换一个数学模型就可以模拟出来并且还可以把他们整合在一"><meta property="og:type" content="article"><meta property="og:title" content="MPM 雪、海绵"><meta property="og:url" content="http://example.com/2023/12/24/simulation/MPMSnow/index.html"><meta property="og:site_name" content="夏猫"><meta property="og:description" content="# MPM 雪、海绵 # 简介 在上一篇文章写完了 MLS-MPM 对于水的模型后，想着记录下其他材质的模拟方法。其实这一篇对现在的项目来说没什么卵用，但打算还是记录下，因为我知道未来在游戏肯定会用上实时模拟，现在所学的没用的东西都是为了未来做铺垫。那么这一篇就写其他弹性材质的其他数学模型。这就是用 MPM 的好处。就是对于其他弹性材料我们只需要换一个数学模型就可以模拟出来并且还可以把他们整合在一"><meta property="og:locale"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-3a8f8f5ceacb922d8f4a1e279e3f94bf_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-26c4dd45963bd007971fbc67a328a11f_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-46b00a9eece18588c0e4eed096b024e9_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-4ea1d477e0ecdd48eb5703b00a7d1f3d_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-e364b80da4c8b25dd10f729bf7da029d_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-1562e392d32c37a781239b57217faa9a_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-0241f6946e80aedc1e2cd4be233a9a16_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-9021c4e511731f4a50740bebd988aa3f_1440w.png"><meta property="article:published_time" content="2023-12-24T04:00:00.000Z"><meta property="article:modified_time" content="2023-12-30T05:58:17.770Z"><meta property="article:author" content="Natsuneko"><meta property="article:tag" content="模拟"><meta property="article:tag" content="文章"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/2023/12/24/simulation/MPMSnow/v2-3a8f8f5ceacb922d8f4a1e279e3f94bf_1440w.png"><meta name="twitter:creator" content="@natsunekosan"><title>MPM 雪、海绵 - 文章 | Natsu neko = 夏猫 = 嵐です！</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">MPM 雪、海绵</h1><div class="meta"><span class="item" title="创建时间：2023-12-24 12:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-12-24T12:00:00+08:00">2023-12-24</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>20k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>19 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Natsu neko</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-6om7ox.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-72o259.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-kwly77.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-rrj6kq.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-q25dq5.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-6o55ml.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%96%87%E7%AB%A0/" itemprop="item" rel="index" title="分类于 文章"><span itemprop="name">文章</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="ch"><link itemprop="mainEntityOfPage" href="http://example.com/2023/12/24/simulation/MPMSnow/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Natsuneko"><meta itemprop="description" content="嵐です！, 主要分享关于 ue 或者 TA 的知识，也或者分享点自己想写的东西，作品什么的"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="夏猫"></span><div class="body md" itemprop="articleBody"><h1 id="mpm雪-海绵"><a class="anchor" href="#mpm雪-海绵">#</a> MPM 雪、海绵</h1><h1 id="简介"><a class="anchor" href="#简介">#</a> <strong>简介</strong></h1><p>在上一篇文章写完了 MLS-MPM 对于水的模型后，想着记录下其他材质的模拟方法。其实这一篇对现在的项目来说没什么卵用，但打算还是记录下，因为我知道未来在游戏肯定会用上实时模拟，现在所学的没用的东西都是为了未来做铺垫。那么这一篇就写其他弹性材质的其他数学模型。这就是用 MPM 的好处。就是对于其他弹性材料我们只需要换一个数学模型就可以模拟出来并且还可以把他们整合在一起产生互相交互，并且只需要在 P2G 上面做材料判断就可以实现，非常简单，不需要水用 FLIP，软体用 FEM 这样重新写一遍。</p><ul><li>Elastic Object （塑形物体）：就是用 Neo Hookean 和 Corotated 模型，这次我们用 Corotated 模型，上面的是 Neo Hookean 模型，下面是 Corotated 模型</li></ul><p><img data-src="v2-3a8f8f5ceacb922d8f4a1e279e3f94bf_1440w.png" alt="v2-3a8f8f5ceacb922d8f4a1e279e3f94bf_1440w.png"></p><p>Elastoplastic objects（弹塑性物体）：例如雪、沙子这些就是软绵绵的又是分散的物体，有很多个模型，例如<span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS9wZGYvMTAuMTE0NS8yNDYxOTEyLjI0NjE5NDg="> ad-hoc boxing</span>、<span class="exturl" data-url="aHR0cHM6Ly93d3cubmF0dXJlLmNvbS9hcnRpY2xlcy9zNDE0NjctMDE4LTA1MTgxLXc=">Cam-clay</span>、<span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS9wZGYvMTAuMTE0NS8yODk3ODI0LjI5MjU5MDY=">Drucker-prager</span>，在实现方面，ad-hoc boxing 是最简单最不物理的，所以我们就用这个模型，后面比较复杂所以我也没看</p><h1 id="雪"><a class="anchor" href="#雪">#</a> <strong>雪</strong></h1><p>雪的解算需要定义弹塑性能量密度方程，就是这个方程将会作用于后面解算的力，那么方程是这样的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Ψ</mi><mo stretchy="false">(</mo><mi>F</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Psi(F)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">Ψ</span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="mclose">)</span></span></span></span>, 根据流动塑性理论我们可以把它分解为 elastic deformation gradient<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>E</mi></msub></mrow><annotation encoding="application/x-tex">F_E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 和 plastic deformation gradient<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>P</mi></msub></mrow><annotation encoding="application/x-tex">F_P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span>, 那么方程就变成了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi mathvariant="normal">Ψ</mi><mo stretchy="false">(</mo><msub><mi>F</mi><mi>E</mi></msub><mo separator="true">,</mo><msub><mi>F</mi><mi>P</mi></msub><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\Psi(F_E,F_P)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord">Ψ</span><span class="mopen">(</span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span></p><p>, 而 elastic deformation gradient 部分我们用 Corotated 模型<span class="exturl" data-url="aHR0cHM6Ly9kMXdxdHh0czF4emxlNy5jbG91ZGZyb250Lm5ldC8zMDg3MjMxNC9TSFNUMTItbGlicmUucGRmPzEzOTIxNDA5MDA9JmFtcDtyZXNwb25zZS1jb250ZW50LWRpc3Bvc2l0aW9uPWlubGluZSUzQitmaWxlbmFtZSUzREVuZXJnZXRpY2FsbHlfQ29uc2lzdGVudF9JbnZlcnRpYmxlX0VsYXMucGRmJmFtcDtFeHBpcmVzPTE3MDMxNzc5NTAmYW1wO1NpZ25hdHVyZT1OY3ZtdWo2RXVGZlZVbEN1MzVIT0hudVR4RGNxVDV3SjRvdFBKTGp3NjFCRHNZNWt+bXpyenJxY2ItNFFDQk9oRDhsbUcwQS1JZmcwcGZSaXJaRkl4aldHSWk4R05NV3l+dDh4VGt3eDRpVi1DcnhCRXdKQnVjQ0RWMEE0Nn56SW5JYlVVNzB6LTVoNjVLRjNFMHFFMkNoQUlnOUp0S05HRDhWTzN+cjlKQk9TR2hEa3gzTy1tbllnazFURkNIbUFUazRZUmgzOWNGTjRvM3NRcWNhLVo1UkxSTTczNG5JcEt5Q0xxZnhMQlF3Z3RScW1lWEw4OU5wUER4U2RnclRlZW5MbW5reEdpWFpKbncyQUR1Y2xLcG9CRUFQTWgzN1Q3THNQcGVKcTRuOVNPSlB5RUFYSHFrOEpTV05GdzU0M0RWZERDRGtXVTJVVXVJbHdrYjBxc1FfXyZhbXA7S2V5LVBhaXItSWQ9QVBLQUpMT0hGNUdHU0xSQlY0WkE="> [Stomakhin et al. 2012]</span>，那么方程就变成了</p><p><img data-src="v2-26c4dd45963bd007971fbc67a328a11f_1440w.png" alt="v2-26c4dd45963bd007971fbc67a328a11f_1440w.png"></p><p>其中<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>J</mi><mi>E</mi></msub><mo>=</mo><mi>d</mi><mi>e</mi><mi>t</mi><msub><mi>F</mi><mi>E</mi></msub><mo separator="true">,</mo><msub><mi>J</mi><mi>P</mi></msub><mo>=</mo><mi>d</mi><mi>e</mi><mi>t</mi><msub><mi>F</mi><mi>P</mi></msub></mrow><annotation encoding="application/x-tex">J_E = det F_E,J_P = det F_P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.09618em">J</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.09618em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.09618em">J</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.09618em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.84444em;vertical-align:-.15em"></span><span class="mord mathnormal">d</span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.09618em">J</span></span></span></span> 就是体积的变化率而<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>E</mi></msub><mo>=</mo><msub><mi>R</mi><mi>E</mi></msub><msub><mi>S</mi><mi>E</mi></msub></mrow><annotation encoding="application/x-tex">F_E= R_ES_E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.00773em">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.00773em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:.05764em">S</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.05764em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 就是使奇异值分解，因为 HLSL 没有自带的奇异值分解，我们就翻译宾夕法尼亚大学开源库 ziran 中的用于实现 MPM 的 SVD 分解，地址在</p><p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3Blbm4tZ3JhcGhpY3MtcmVzZWFyY2gvemlyYW4yMDE5L2Jsb2IvbWFzdGVyL0xpYi9aaXJhbi9NYXRoL0xpbmVhci9JbXBsaWNpdFFSU1ZELmg="></span></p><p>顺便说一下 SVD 是什么，在二维里面一个形变矩阵可以分解为</p><p><img data-src="v2-46b00a9eece18588c0e4eed096b024e9_1440w.png" alt="v2-46b00a9eece18588c0e4eed096b024e9_1440w.png"></p><p>U・Sigma・V^t，就是先是旋转，缩放，然后再旋转，就得到最终的变换。而上面的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>R</mi><mi>E</mi></msub></mrow><annotation encoding="application/x-tex">R_E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.00773em">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.00773em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 就是旋转矩阵部分，就是 mul（U，transpos（V））。那么为什么要分解形变矩阵 F 呢，是因为我们要对 F 旋转部分给剔除掉，只要他的施加弹性力形变的大小</p><p>说回函数，Corotated 模型里面定义了<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>μ</mi><mtext>和</mtext><mi>λ</mi></mrow><annotation encoding="application/x-tex">\mu和\lambda</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord mathnormal">μ</span><span class="mord cjk_fallback">和</span><span class="mord mathnormal">λ</span></span></span></span> 两个参数</p><p><img data-src="v2-4ea1d477e0ecdd48eb5703b00a7d1f3d_1440w.png" alt="v2-4ea1d477e0ecdd48eb5703b00a7d1f3d_1440w.png"></p><p>然后我们还要限制一个弹性力的临界压缩，因为我们经过 SVD 分解得到 sigma 这个值，就是 弹性力大小，我们对他进行限制，然后把力分给塑形力，那么为什么这么做的呢？想象一下你手抓一个雪球用力挤压他，这时候就是对他施加弹性力，现在他的大型改变了，但他还是一个球，但超过一个临界值，他爆开了，那么多出这一部分就是他塑形力，所以我们</p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>E</mi></msub></mrow><annotation encoding="application/x-tex">F_E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 限制在<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">[</mo><mn>1</mn><mo>−</mo><msub><mi>θ</mi><mi>c</mi></msub><mo separator="true">,</mo><mn>1</mn><mo>+</mo><msub><mi>θ</mi><mi>s</mi></msub><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">[1 - \theta_c,1+\theta_s]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">[</span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:.8888799999999999em;vertical-align:-.19444em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.02778em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord">1</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02778em">θ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.151392em"><span style="top:-2.5500000000000003em;margin-left:-.02778em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mclose">]</span></span></span></span>，然后把这部分的值补充回塑形形变的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>J</mi></mrow><annotation encoding="application/x-tex">J</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.68333em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.09618em">J</span></span></span></span> 上，的在论文中推荐了几个值</p><p><img data-src="v2-e364b80da4c8b25dd10f729bf7da029d_1440w.png" alt="v2-e364b80da4c8b25dd10f729bf7da029d_1440w.png"></p><p>这时候一个 grid 总弹性势能可以写成</p><p><img data-src="v2-1562e392d32c37a781239b57217faa9a_1440w.png" alt="v2-1562e392d32c37a781239b57217faa9a_1440w.png"></p><p>对于更新形变矩阵 F，我们还是用回上一篇文章的 F 更新</p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mi>F</mi><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><mo stretchy="false">(</mo><mtext mathvariant="bold">I</mtext><mo>+</mo><mi mathvariant="normal">Δ</mi><mi>t</mi><msubsup><mtext mathvariant="bold">C</mtext><mi>p</mi><mi>n</mi></msubsup><mo stretchy="false">)</mo><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mi>n</mi></msubsup><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex">{F}_p^{n+1}=(\textbf I+\Delta t \textbf C_p^n)\textbf{F}_p^{n} \\</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.197216em;vertical-align:-.383108em"></span><span class="mord"><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">I</span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.133108em;vertical-align:-.383108em"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord text"><span class="mord textbf">C</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span></span><span class="mspace newline"></span></span></span></p><p>那么现在总弹性势能就是 stress force，替换上一篇文章的公式就可以写成</p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mtext mathvariant="bold">v</mtext><msubsup><mo stretchy="false">)</mo><mi>i</mi><mi>n</mi></msubsup><mo>=</mo><msub><mo>∑</mo><mi>p</mi></msub><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>p</mi></mrow></msub><mrow><mo fence="true">{</mo><msub><mi>m</mi><mi>p</mi></msub><msubsup><mtext mathvariant="bold">v</mtext><mi>p</mi><mi>n</mi></msubsup><mo>+</mo><mrow><mo fence="true">[</mo><msub><mi>m</mi><mi>p</mi></msub><msubsup><mtext mathvariant="bold">C</mtext><mi>p</mi><mi>n</mi></msubsup><mo>−</mo><mfrac><mrow><mn>4</mn><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow><mrow><mi mathvariant="normal">Δ</mi><msup><mi>x</mi><mn>2</mn></msup></mrow></mfrac><msub><mo>∑</mo><mi>p</mi></msub><msubsup><mi>V</mi><mi>p</mi><mn>0</mn></msubsup><mtext mathvariant="bold">P</mtext><mo stretchy="false">(</mo><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup><mo fence="true">]</mo></mrow><mo stretchy="false">(</mo><msub><mtext mathvariant="bold">x</mtext><mi>i</mi></msub><mo>−</mo><msubsup><mtext mathvariant="bold">x</mtext><mi>p</mi><mi>n</mi></msubsup><mo stretchy="false">)</mo><mo fence="true">}</mo></mrow></mrow><annotation encoding="application/x-tex">(m\textbf v)_i^{n}=\sum_pw_{i,p} \left\{ m_p \textbf v_p^n+\left[m_p\textbf C_p^n-\frac{4\Delta t}{\Delta x^2}\sum_p V_p^0\textbf P(\textbf F_p^{n+1})(\textbf F_p^{n+1})^T \right](\textbf x_i-\textbf x_p^n)\right\}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.008664em;vertical-align:-.258664em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord text"><span class="mord textbf">v</span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-2.441336em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.258664em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.80002em;vertical-align:-.65002em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.0016819999999999613em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.43581800000000004em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.02691em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="minner"><span class="mopen delimcenter" style="top:0"><span class="delimsizing size2">{</span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord textbf">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="minner"><span class="mopen delimcenter" style="top:0"><span class="delimsizing size2">[</span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord textbf">C</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.872331em"><span style="top:-2.6550000000000002em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">Δ</span><span class="mord mtight"><span class="mord mathnormal mtight">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.7463142857142857em"><span style="top:-2.786em;margin-right:.07142857142857144em"><span class="pstrut" style="height:2.5em"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.394em"><span class="pstrut" style="height:3em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">4</span><span class="mord mtight">Δ</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.345em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:-.0000050000000000050004em">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.0016819999999999613em"><span style="top:-2.40029em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.43581800000000004em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-2.4530000000000003em;margin-left:-.22222em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mord text"><span class="mord textbf">P</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.890118em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.13901em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.890118em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.13901em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8413309999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.13889em">T</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0"><span class="delimsizing size2">]</span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0"><span class="delimsizing size2">}</span></span></span></span></span></span></p><p>那么这样就是一个雪模拟公式，后面的还是跟上一篇文章一样，在 P2G 上修改一下。</p><p>总结一下上面流程</p><p><img data-src="v2-0241f6946e80aedc1e2cd4be233a9a16_1440w.png" alt="v2-0241f6946e80aedc1e2cd4be233a9a16_1440w.png"></p><p>1、第一步首先更新形变矩阵 F<br>2、然后对他进行 SVD 分解<br>3、约束 SVD 解出来的 sigma<br>4、重建原来 F 矩阵</p><h2 id="niagara实现"><a class="anchor" href="#niagara实现">#</a> <strong><strong>Niagara 实现</strong></strong></h2><p>雪 P2G 部分<br>``</p><p></p><figure class="highlight glsl"><figcaption><span>P2G</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><code class="hljs glsl">Functions Fu;<br><span class="hljs-type">int</span> Cellx;<br><span class="hljs-type">int</span> Celly;<br><span class="hljs-type">int</span> Cellz;<br>RasterizationGrid3D.GetNumCells(Cellx, Celly, Cellz);<br><span class="hljs-type">float</span> dx = <span class="hljs-number">1</span>/ (<span class="hljs-type">float</span>)Cellx;<span class="hljs-comment">//((float)Cellx / WorldSize.x);</span><br><span class="hljs-type">float</span> DeltaDx = dx*dx;<br><br>float3 CellPosition =  Position * Cellx ;<br><br>float3 BasePosition = <span class="hljs-built_in">floor</span>(CellPosition - <span class="hljs-number">0.5</span>);<br>float3 FPosition = CellPosition - BasePosition;<br><br>float3 Weight[<span class="hljs-number">3</span>];<br><span class="hljs-type">float</span> IGNORE ;<br>Weight[<span class="hljs-number">0</span>] = <span class="hljs-number">0.5</span> * (<span class="hljs-number">1.5</span> - FPosition) * (<span class="hljs-number">1.5</span> - FPosition);<br>Weight[<span class="hljs-number">1</span>] = <span class="hljs-number">0.75</span> - (FPosition - <span class="hljs-number">1</span>) * (FPosition - <span class="hljs-number">1</span>);<br>Weight[<span class="hljs-number">2</span>] = <span class="hljs-number">0.5</span> * (FPosition - <span class="hljs-number">0.5</span>) * (FPosition - <span class="hljs-number">0.5</span>);<br><br><span class="hljs-type">float</span> pvol = <span class="hljs-built_in">pow</span>(dx*<span class="hljs-number">0.5</span> ,<span class="hljs-number">3</span>);<br>float4x4 Identity = float4x4(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br><br>F = mul(Identity + DeltaTime * C,F);<br><br><span class="hljs-type">float</span> h = <span class="hljs-built_in">exp</span>(<span class="hljs-number">10</span> * (<span class="hljs-number">1</span>-J));<br><span class="hljs-type">float</span> mu = (E / (<span class="hljs-number">2</span> * (<span class="hljs-number">1</span> + nu))) * h;<br><span class="hljs-type">float</span> la = (E * nu / ((<span class="hljs-number">1</span> + nu) * (<span class="hljs-number">1</span> - <span class="hljs-number">2</span> * nu))) * h;<br>TestVector = float3(mu,la,<span class="hljs-number">0</span>) / h;<br>float3x3 u = <span class="hljs-number">0.</span>f;<br>float3 s = <span class="hljs-number">0.</span>f;<br>float3x3 v = <span class="hljs-number">0.</span>f;<br>float3x3 TempF;<br>Fu.ConverMatrix(F,TempF);<br>Fu.svd(TempF,u,s,v);<br><br><span class="hljs-type">float</span> JE = <span class="hljs-number">1.</span>f;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++)<br>&#123;<br>	s[i] = <span class="hljs-built_in">max</span>(s[i],<span class="hljs-number">1e-6</span>);<br>	<span class="hljs-type">float</span> MaxValue = <span class="hljs-number">1.0075</span>;<span class="hljs-comment">//1 + 4.5e-3;//1.0075;//</span><br>	<span class="hljs-type">float</span> MinValue =<span class="hljs-number">0.975</span>;<span class="hljs-comment">//1 - 2.5e-2;//0.975;//</span><br>	<span class="hljs-type">float</span> NewSig = s[i];<br>		NewSig= <span class="hljs-built_in">clamp</span>(s[i],MinValue,MaxValue);<br>	J *= (s[i] / NewSig);<br>	s[i] = NewSig;<br>	JE *= s[i];<br>&#125;<br><br>float4x4 NewU;<br>Fu.ConverMatrix(u,NewU);<br><br>float4x4 NewV;<br>Fu.ConverMatrix(v,NewV);<br>TestM = NewU;<br>float4x4 SMatrix = float4x4(s.x,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>	<span class="hljs-number">0</span>,s.y,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br>	<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,s.z,<span class="hljs-number">0</span>,<br>	<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>);<br>F = mul(mul(NewU,SMatrix),<span class="hljs-built_in">transpose</span>(NewV));<br>OutF = F;<br>OutJ = J;<br><br>float4x4 Stress = <span class="hljs-number">2</span> * mu * mul(<span class="hljs-built_in">transpose</span>(F), F -mul( NewU,<span class="hljs-built_in">transpose</span>(NewV)) ) + (Identity * la * JE * (JE - <span class="hljs-number">1</span>));<br>Stress = (-DeltaTime * pvol * <span class="hljs-number">4</span> /DeltaDx) * Stress;<br>float4x4 Affine =  Stress + Mass * C;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;x&lt;<span class="hljs-number">3</span>;x++)<br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">3</span>; y++)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> z = <span class="hljs-number">0</span>; z&lt;<span class="hljs-number">3</span>; z++)<br>        &#123;<br>            float3 <span class="hljs-keyword">offset</span> = float3(x,y,z);<br>            float3 Dpos = (<span class="hljs-keyword">offset</span> - FPosition) * dx;<br>            <span class="hljs-type">int</span> IndexX = BasePosition.x + <span class="hljs-keyword">offset</span>.x;<br>            <span class="hljs-type">int</span> IndexY = BasePosition.y + <span class="hljs-keyword">offset</span>.y;<br>            <span class="hljs-type">int</span> IndexZ = BasePosition.z + <span class="hljs-keyword">offset</span>.z;<br>            <span class="hljs-keyword">if</span>(IndexX &lt; Cellx&amp;&amp;IndexY &lt; Celly&amp;&amp;IndexZ &lt; Cellz&amp;&amp;<br>                IndexX &gt; <span class="hljs-number">0</span>&amp;&amp;IndexY &gt; <span class="hljs-number">0</span>&amp;&amp;IndexZ &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-type">float</span> CellWeight = Weight[x].x*Weight[y].y*Weight[z].z;<br>                float4 GridData = <span class="hljs-number">0</span>;<br>               <span class="hljs-comment">// Grid3D.GetPreviousVector4ValueAtIndex(IndexX, IndexY, IndexZ, 0, GridData);</span><br>                float4 GridVelocity ;<span class="hljs-comment">//= GridData.xyz ;</span><br>                float4 Mpos = float4(Dpos,<span class="hljs-number">0</span>);<br>                GridVelocity = CellWeight*(Mass * float4(Velocity,<span class="hljs-number">0</span>) + mul(Affine,Mpos));<br>               <br>                <span class="hljs-type">float</span> GridMass ;<span class="hljs-comment">//= GridData.w;</span><br>                GridMass =  CellWeight * Mass;<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">0</span>, GridVelocity.x,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">1</span>, GridVelocity.y,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">2</span>, GridVelocity.z,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">3</span>, GridMass,IGNORE);<br>                <br>                <span class="hljs-comment">//Grid3D.SetVector4ValueAtIndex(IndexX, IndexY, IndexZ, 0, float4(GridVelocity,GridMass));</span><br><br>            &#125;<br>            <br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p></p><p><img data-src="v2-9021c4e511731f4a50740bebd988aa3f_1440w.png" alt="v2-9021c4e511731f4a50740bebd988aa3f_1440w.png"></p><h1 id="弹性体"><a class="anchor" href="#弹性体">#</a> <strong>弹性体</strong></h1><p>因为上面 Corotated 模型本来是个弹塑性物体的模拟模型，我们把雪关于弹性</p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>E</mi></msub></mrow><annotation encoding="application/x-tex">F_E</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.05764em">E</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 和塑形<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>F</mi><mi>P</mi></msub></mrow><annotation encoding="application/x-tex">F_P</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.13889em">F</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.32833099999999993em"><span style="top:-2.5500000000000003em;margin-left:-.13889em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.13889em">P</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span></p><p>的一部分删除了就可以实现 softbody 模拟，顺便说一下这对于 FEM 来说最大的优势就在自碰撞，我文章写过一个 FEM，但其中可以看出，他没有自碰撞，只是单纯求 F。最后 MPM 的 SoftBody 代码是这样的，这个 Softbody 还可以断裂的</p><p></p><figure class="highlight glsl"><figcaption><span>G2P</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><code class="hljs glsl">Functions Fu;<br><span class="hljs-type">int</span> Cellx;<br><span class="hljs-type">int</span> Celly;<br><span class="hljs-type">int</span> Cellz;<br>RasterizationGrid3D.GetNumCells(Cellx, Celly, Cellz);<br><span class="hljs-type">float</span> dx = <span class="hljs-number">1</span>/ (<span class="hljs-type">float</span>)Cellx;<span class="hljs-comment">//((float)Cellx / WorldSize.x);</span><br><span class="hljs-type">float</span> DeltaDx = dx*dx;<br><br>float3 CellPosition =  Position * Cellx ;<br><br>float3 BasePosition = <span class="hljs-built_in">floor</span>(CellPosition - <span class="hljs-number">0.5</span>);<br>float3 FPosition = CellPosition - BasePosition;<br><br>float3 Weight[<span class="hljs-number">3</span>];<br><span class="hljs-type">float</span> IGNORE ;<br>Weight[<span class="hljs-number">0</span>] = <span class="hljs-number">0.5</span> * (<span class="hljs-number">1.5</span> - FPosition) * (<span class="hljs-number">1.5</span> - FPosition);<br>Weight[<span class="hljs-number">1</span>] = <span class="hljs-number">0.75</span> - (FPosition - <span class="hljs-number">1</span>) * (FPosition - <span class="hljs-number">1</span>);<br>Weight[<span class="hljs-number">2</span>] = <span class="hljs-number">0.5</span> * (FPosition - <span class="hljs-number">0.5</span>) * (FPosition - <span class="hljs-number">0.5</span>);<br><br><span class="hljs-type">float</span> pvol = <span class="hljs-built_in">pow</span>(dx*<span class="hljs-number">0.5</span> ,<span class="hljs-number">3</span>);<br>float4x4 Identity = float4x4(<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br><br>F = mul(Identity + DeltaTime * C,F);<br><br><span class="hljs-type">float</span> h = <span class="hljs-number">0.3</span>;<span class="hljs-comment">//exp(10 * (1-J));</span><br><span class="hljs-type">float</span> mu = (E / (<span class="hljs-number">2</span> * (<span class="hljs-number">1</span> + nu))) * h;<br><span class="hljs-type">float</span> la = (E * nu / ((<span class="hljs-number">1</span> + nu) * (<span class="hljs-number">1</span> - <span class="hljs-number">2</span> * nu))) * h;<br>TestVector = float3(mu,la,<span class="hljs-number">0</span>) / h;<br>float3x3 u = <span class="hljs-number">0.</span>f;<br>float3 s = <span class="hljs-number">0.</span>f;<br>float3x3 v = <span class="hljs-number">0.</span>f;<br>float3x3 TempF;<br>Fu.ConverMatrix(F,TempF);<br>Fu.svd(TempF,u,s,v);<br><br><span class="hljs-type">float</span> JT = <span class="hljs-number">1.</span>f;<br><br>float4x4 NewU;<br>Fu.ConverMatrix(u,NewU);<br><br>float4x4 NewV;<br>Fu.ConverMatrix(v,NewV);<br>TestM = NewU;<br><br>OutF = F;<br>OutJ = J;<br><br>float4x4 Stress = <span class="hljs-number">2</span> * mu * mul(<span class="hljs-built_in">transpose</span>(F), F -mul( NewU,<span class="hljs-built_in">transpose</span>(NewV)) ) + (Identity * la * JT * (JT - <span class="hljs-number">1</span>));<br>Stress = (-DeltaTime * pvol * <span class="hljs-number">4</span> /DeltaDx) * Stress;<br>float4x4 Affine =  Stress + Mass * C;<br><br><span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> x = <span class="hljs-number">0</span>;x&lt;<span class="hljs-number">3</span>;x++)<br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">3</span>; y++)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> z = <span class="hljs-number">0</span>; z&lt;<span class="hljs-number">3</span>; z++)<br>        &#123;<br>            float3 <span class="hljs-keyword">offset</span> = float3(x,y,z);<br>            float3 Dpos = (<span class="hljs-keyword">offset</span> - FPosition) * dx;<br>            <span class="hljs-type">int</span> IndexX = BasePosition.x + <span class="hljs-keyword">offset</span>.x;<br>            <span class="hljs-type">int</span> IndexY = BasePosition.y + <span class="hljs-keyword">offset</span>.y;<br>            <span class="hljs-type">int</span> IndexZ = BasePosition.z + <span class="hljs-keyword">offset</span>.z;<br>            <span class="hljs-keyword">if</span>(IndexX &lt; Cellx&amp;&amp;IndexY &lt; Celly&amp;&amp;IndexZ &lt; Cellz&amp;&amp;<br>                IndexX &gt; <span class="hljs-number">0</span>&amp;&amp;IndexY &gt; <span class="hljs-number">0</span>&amp;&amp;IndexZ &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-type">float</span> CellWeight = Weight[x].x*Weight[y].y*Weight[z].z;<br>                float4 GridData = <span class="hljs-number">0</span>;<br>               <span class="hljs-comment">// Grid3D.GetPreviousVector4ValueAtIndex(IndexX, IndexY, IndexZ, 0, GridData);</span><br>                float4 GridVelocity ;<span class="hljs-comment">//= GridData.xyz ;</span><br>                float4 Mpos = float4(Dpos,<span class="hljs-number">0</span>);<br>                GridVelocity = CellWeight*(Mass * float4(Velocity,<span class="hljs-number">0</span>) + mul(Affine,Mpos));<br>               <br>                <span class="hljs-type">float</span> GridMass ;<span class="hljs-comment">//= GridData.w;</span><br>                GridMass =  CellWeight * Mass;<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">0</span>, GridVelocity.x,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">1</span>, GridVelocity.y,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">2</span>, GridVelocity.z,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">3</span>, GridMass,IGNORE);<br>                <br>                <span class="hljs-comment">//Grid3D.SetVector4ValueAtIndex(IndexX, IndexY, IndexZ, 0, float4(GridVelocity,GridMass));</span><br><br>            &#125;<br>            <br><br>        &#125;<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><p></p><h1 id="svd代码"><a class="anchor" href="#svd代码">#</a> <strong><strong>SVD 代码</strong></strong></h1><p></p><figure class="highlight glsl"><figcaption><span>SVD</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br></pre></td><td class="code"><pre><code class="hljs glsl">struct Functions<br>&#123;<br><span class="hljs-meta">#define EPSILON 1e-10</span><br><br>	<span class="hljs-comment">// Function to create a 2x2 rotation matrix</span><br>	float2x2 G2(<span class="hljs-type">float</span> c, <span class="hljs-type">float</span> s)<br>	&#123;<br>		<span class="hljs-keyword">return</span> float2x2(c, s, -s, c);<br>	&#125;<br><br>	<span class="hljs-comment">// Function to compute Givens rotation for constrained case</span><br>	float2 G2_Con(<span class="hljs-type">float</span> a, <span class="hljs-type">float</span> b)<br>	&#123;<br>		<span class="hljs-type">float</span> d = a * a + b * b;<br>		<span class="hljs-type">float</span> c = <span class="hljs-number">1</span>;<br>		<span class="hljs-type">float</span> s = <span class="hljs-number">0</span>;<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(d) &gt; <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-type">float</span> t = <span class="hljs-number">1.0</span> / <span class="hljs-built_in">sqrt</span>(d);<br>			c = a * t;<br>			s = -b * t;<br>		&#125;<br><br>		<span class="hljs-keyword">return</span> float2(c, s);<br>	&#125;<br><br>	<span class="hljs-comment">// Function to compute Givens rotation for unconstrained case</span><br>	float2 G2_unCon(<span class="hljs-type">float</span> a, <span class="hljs-type">float</span> b)<br>	&#123;<br>		<span class="hljs-type">float</span> d = a * a + b * b;<br>		<span class="hljs-type">float</span> c = <span class="hljs-number">1</span>;<br>		<span class="hljs-type">float</span> s = <span class="hljs-number">0</span>;<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(d) &gt; <span class="hljs-number">0</span>)<br>		&#123;<br>			<span class="hljs-type">float</span> t = <span class="hljs-number">1.0</span> / <span class="hljs-built_in">sqrt</span>(d);<br>			c = a * t;<br>			s = b * t;<br>		&#125;<br><br>		<span class="hljs-keyword">return</span> float2(c, s);<br>	&#125;<br><br>	<span class="hljs-comment">// Function to create a 3x3 matrix for Givens rotation in the 1-2 plane</span><br>	float3x3 G3_12(<span class="hljs-type">float</span> c, <span class="hljs-type">float</span> s, <span class="hljs-type">bool</span> con = <span class="hljs-literal">true</span>)<br>	&#123;<br>		float2 cs = con ? G2_Con(c, s) : G2_unCon(c, s);<br>		<span class="hljs-keyword">return</span> float3x3(float3(cs.x, cs.y, <span class="hljs-number">0</span>), float3(-cs.y, cs.x, <span class="hljs-number">0</span>), float3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>));<br>	&#125;<br><br>	float3x3 G3_12_Direct(<span class="hljs-type">float</span> c, <span class="hljs-type">float</span> s)<br>	&#123;<br>		<span class="hljs-keyword">return</span> float3x3(float3(c, s, <span class="hljs-number">0</span>), float3(-s, c, <span class="hljs-number">0</span>), float3(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>));<br>	&#125;<br><br>	<span class="hljs-comment">// Function to create a 3x3 matrix for Givens rotation in the 2-3 plane</span><br>	float3x3 G3_23(<span class="hljs-type">float</span> c, <span class="hljs-type">float</span> s, <span class="hljs-type">bool</span> con = <span class="hljs-literal">true</span>)<br>	&#123;<br>		float2 cs = con ? G2_Con(c, s) : G2_unCon(c, s);<br>		<span class="hljs-keyword">return</span> float3x3(float3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), float3(<span class="hljs-number">0</span>, cs.x, cs.y), float3(<span class="hljs-number">0</span>, -cs.y, cs.x));<br>	&#125;<br><br>	float3x3 G3_23_Direct(<span class="hljs-type">float</span> c, <span class="hljs-type">float</span> s)<br>	&#123;<br>		<span class="hljs-keyword">return</span> float3x3(float3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>), float3(<span class="hljs-number">0</span>, c, s), float3(<span class="hljs-number">0</span>, -s, c));<br>	&#125;<br><br>	<span class="hljs-comment">// Function to create a 3x3 matrix for Givens rotation in the 1-3 plane</span><br>	float3x3 G3_13(<span class="hljs-type">float</span> c, <span class="hljs-type">float</span> s, <span class="hljs-type">bool</span> con = <span class="hljs-literal">true</span>)<br>	&#123;<br>		float2 cs = con ? G2_Con(c, s) : G2_unCon(c, s);<br>		<span class="hljs-keyword">return</span> float3x3(float3(cs.x, <span class="hljs-number">0</span>, cs.y), float3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>), float3(-cs.y, <span class="hljs-number">0</span>, cs.x));<br>	&#125;<br><br>	float3x3 G3_13_Direct(<span class="hljs-type">float</span> c, <span class="hljs-type">float</span> s)<br>	&#123;<br>		<span class="hljs-keyword">return</span> float3x3(float3(c, <span class="hljs-number">0</span>, s), float3(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>), float3(-s, <span class="hljs-number">0</span>, c));<br>	&#125;<br><br>	<span class="hljs-comment">// Function for polar decomposition</span><br>	<span class="hljs-type">void</span> PolarDecompostion(float2x2 A, <span class="hljs-keyword">out</span> float2x2 R, <span class="hljs-keyword">out</span> float2x2 S)<br>	&#123;<br>		<span class="hljs-type">float</span> x = A[<span class="hljs-number">0</span>].x + A[<span class="hljs-number">1</span>].y;<br>		<span class="hljs-type">float</span> y = A[<span class="hljs-number">1</span>].x - A[<span class="hljs-number">0</span>].y;<br>		<span class="hljs-type">float</span> d = <span class="hljs-built_in">sqrt</span>(x * x + y * y);<br><br>		R = float2x2(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(d) &gt; EPSILON)<br>		&#123;<br>			d = <span class="hljs-number">1</span> / d;<br>			R = G2(x * d, -y * d);<br>		&#125;<br><br>		S = mul(<span class="hljs-built_in">transpose</span>(R), A);<br>	&#125;<br><br>	<span class="hljs-comment">// Function for singular value decomposition of a 2x2 matrix</span><br>	<span class="hljs-type">void</span> SVD2x2(float2x2 A, <span class="hljs-keyword">out</span> float2x2 U, <span class="hljs-keyword">out</span> float2 D, <span class="hljs-keyword">out</span> float2x2 V)<br>	&#123;<br>		U = float2x2(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>		D = float2(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>		V = float2x2(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br><br>		float2x2 R, S;<br>		PolarDecompostion(A, R, S);<br><br>		<span class="hljs-type">float</span> c = <span class="hljs-number">1</span>;<br>		<span class="hljs-type">float</span> s = <span class="hljs-number">0</span>;<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(S[<span class="hljs-number">0</span>].y) &lt; EPSILON)<br>		&#123;<br>			D.x = S[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];<br>			D.y = S[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>];<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			<span class="hljs-type">float</span> taw = <span class="hljs-number">0.5</span> * (S[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] - S[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]);<br>			<span class="hljs-type">float</span> w = <span class="hljs-built_in">sqrt</span>(taw * taw + S[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] * S[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]);<br><br>			<span class="hljs-type">float</span> t = <span class="hljs-number">0</span>;<br><br>			<span class="hljs-keyword">if</span> (taw &gt; <span class="hljs-number">0</span>)<br>				t = S[<span class="hljs-number">0</span>].y / (taw + w);<br>			<span class="hljs-keyword">else</span><br>				t = S[<span class="hljs-number">0</span>].y / (taw - w);<br><br>			c = <span class="hljs-number">1.0</span> / <span class="hljs-built_in">sqrt</span>(t * t + <span class="hljs-number">1</span>);<br>			s = -t * c;<br><br>			D.x = (c * c * S[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]) - (<span class="hljs-number">2</span> * c * s * S[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]) + (s * s * S[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]);<br>			D.y = (s * s * S[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>]) + (<span class="hljs-number">2</span> * c * s * S[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>]) + (c * c * S[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>]);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (D.x &lt; D.y)<br>		&#123;<br>			<span class="hljs-type">float</span> temp = D.x;<br>			D.x = D.y;<br>			D.y = temp;<br>			V = G2(-s, c);<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			V = G2(c, s);<br>		&#125;<br><br>		U = mul(R, V);<br>	&#125;<br><br>	<span class="hljs-comment">// Other functions and main SVD3x3 function go here...</span><br>	<span class="hljs-comment">// Function to perform zero chasing</span><br>	<span class="hljs-type">void</span> ZeroChasing(<span class="hljs-keyword">inout</span> float3x3 U, <span class="hljs-keyword">inout</span> float3x3 A, <span class="hljs-keyword">inout</span> float3x3 V)<br>	&#123;<br>		float3x3 G = G3_12(A[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>], A[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]);<br>		A = mul(<span class="hljs-built_in">transpose</span>(G), A);<br>		U = mul(U, G);<br><br>		<span class="hljs-type">float</span> c = A[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>];<br>		<span class="hljs-type">float</span> s = A[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>];<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(A[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>]) &gt; EPSILON)<br>		&#123;<br>			c = A[<span class="hljs-number">0</span>].x * A[<span class="hljs-number">0</span>][<span class="hljs-number">1</span>] + A[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] * A[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>];<br>			s = A[<span class="hljs-number">0</span>].x * A[<span class="hljs-number">0</span>][<span class="hljs-number">2</span>] + A[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>] * A[<span class="hljs-number">1</span>][<span class="hljs-number">2</span>];<br>		&#125;<br><br>		G = G3_23(c, s);<br>		A = mul(A, G);<br>		V = mul(V, G);<br><br>		G = G3_23(A[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>], A[<span class="hljs-number">2</span>][<span class="hljs-number">1</span>]);<br>		A = mul(<span class="hljs-built_in">transpose</span>(G), A);<br>		U = mul(U, G);<br>	&#125;<br><br>	<span class="hljs-comment">// Function to perform bidiagonalization</span><br>	<span class="hljs-type">void</span> Bidiag(<span class="hljs-keyword">inout</span> float3x3 U, <span class="hljs-keyword">inout</span> float3x3 A, <span class="hljs-keyword">inout</span> float3x3 V)<br>	&#123;<br>		float3x3 G = G3_23(A[<span class="hljs-number">1</span>][<span class="hljs-number">0</span>], A[<span class="hljs-number">2</span>][<span class="hljs-number">0</span>]);<br>		A = mul(<span class="hljs-built_in">transpose</span>(G), A);<br>		U = mul(U, G);<br>		ZeroChasing(U, A, V);<br>	&#125;<br><br>	<span class="hljs-comment">// Function to compute Frobenius norm of a 3x3 matrix</span><br>	<span class="hljs-type">float</span> FrobeniusNorm(float3x3 B)<br>	&#123;<br>		<span class="hljs-type">float</span> ret = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> i =<span class="hljs-number">0</span>;i&lt;<span class="hljs-number">3</span>;i++ )<br>		&#123;<br>			<span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> j =<span class="hljs-number">0</span>;j&lt;<span class="hljs-number">3</span>;j++ )<br>			&#123;<br>				ret += B[i][j]*B[i][j];<br>			&#125;<br>		&#125;<br>		<span class="hljs-keyword">return</span> ret;<span class="hljs-comment">//dot(B[0], B[0]) + dot(B[1], B[1]) + dot(B[2], B[2]);</span><br>	&#125;<br><br>	<span class="hljs-comment">// Function to flip signs in a matrix and sigma vector</span><br>	<span class="hljs-type">void</span> FlipSign(<span class="hljs-type">int</span> idx, <span class="hljs-keyword">inout</span> float3x3 mat, <span class="hljs-keyword">inout</span> float3 sigma)<br>	&#123;<br>		mat[<span class="hljs-number">0</span>][idx] = -mat[<span class="hljs-number">0</span>][idx];<br>		mat[<span class="hljs-number">1</span>][idx] = -mat[<span class="hljs-number">1</span>][idx];<br>		mat[<span class="hljs-number">2</span>][idx] = -mat[<span class="hljs-number">2</span>][idx];<br>		sigma[idx] = -sigma[idx];<br>	&#125;<br><br>	<span class="hljs-comment">// Function to flip signs in a specific column of a matrix</span><br>	<span class="hljs-type">void</span> FlipSignColumn(<span class="hljs-keyword">inout</span> float3x3 mat, <span class="hljs-type">int</span> idx)<br>	&#123;<br>		mat[<span class="hljs-number">0</span>][idx] = -mat[<span class="hljs-number">0</span>][idx];<br>		mat[<span class="hljs-number">1</span>][idx] = -mat[<span class="hljs-number">1</span>][idx];<br>		mat[<span class="hljs-number">2</span>][idx] = -mat[<span class="hljs-number">2</span>][idx];<br>	&#125;<br><br>	<span class="hljs-comment">// Function to swap columns in a matrix</span><br>	<span class="hljs-type">void</span> SwapColumn(<span class="hljs-keyword">inout</span> float3x3 a, <span class="hljs-type">int</span> col_a, <span class="hljs-type">int</span> col_b)<br>	&#123;<br>		float3 acopy = a[col_a];<br>		a[col_a] = a[col_b];<br>		a[col_b] = acopy;<br>	&#125;<br><br>	<span class="hljs-comment">// Function to sort with top-left singular value</span><br>	<span class="hljs-type">void</span> SortWithTopLeft(<span class="hljs-keyword">inout</span> float3x3 U, <span class="hljs-keyword">inout</span> float3 sigma, <span class="hljs-keyword">inout</span> float3x3 V)<br>	&#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(sigma[<span class="hljs-number">1</span>]) &gt;= <span class="hljs-built_in">abs</span>(sigma[<span class="hljs-number">2</span>]))<br>		&#123;<br>			<span class="hljs-keyword">if</span> (sigma[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span>)<br>			&#123;<br>				FlipSign(<span class="hljs-number">1</span>, U, sigma);<br>				FlipSign(<span class="hljs-number">2</span>, U, sigma);<br>			&#125;<br><br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sigma[<span class="hljs-number">2</span>] &lt; <span class="hljs-number">0</span>)<br>		&#123;<br>			FlipSign(<span class="hljs-number">1</span>, U, sigma);<br>			FlipSign(<span class="hljs-number">2</span>, U, sigma);<br>		&#125;<br><br>		<span class="hljs-type">float</span> temp = sigma[<span class="hljs-number">1</span>];<br>		sigma[<span class="hljs-number">1</span>] = sigma[<span class="hljs-number">2</span>];<br>		sigma[<span class="hljs-number">2</span>] = temp;<br><br>		SwapColumn(U, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>		SwapColumn(V, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br><br>		<span class="hljs-keyword">if</span> (sigma[<span class="hljs-number">1</span>] &gt; sigma[<span class="hljs-number">0</span>])<br>		&#123;<br>			temp = sigma[<span class="hljs-number">0</span>];<br>			sigma[<span class="hljs-number">0</span>] = sigma[<span class="hljs-number">1</span>];<br>			sigma[<span class="hljs-number">1</span>] = temp;<br><br>			SwapColumn(U, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>			SwapColumn(V, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			FlipSignColumn(U, <span class="hljs-number">2</span>);<br>			FlipSignColumn(V, <span class="hljs-number">2</span>);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// Function to sort with bottom-right singular value</span><br>	<span class="hljs-type">void</span> SortWithBotRight(<span class="hljs-keyword">inout</span> float3x3 U, <span class="hljs-keyword">inout</span> float3 sigma, <span class="hljs-keyword">inout</span> float3x3 V)<br>	&#123;<br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(sigma[<span class="hljs-number">0</span>]) &gt;= <span class="hljs-built_in">abs</span>(sigma[<span class="hljs-number">1</span>]))<br>		&#123;<br>			<span class="hljs-keyword">if</span> (sigma[<span class="hljs-number">0</span>] &lt; <span class="hljs-number">0</span>)<br>			&#123;<br>				FlipSign(<span class="hljs-number">0</span>, U, sigma);<br>				FlipSign(<span class="hljs-number">2</span>, U, sigma);<br>			&#125;<br><br>			<span class="hljs-keyword">return</span>;<br>		&#125;<br><br>		<span class="hljs-type">float</span> temp = sigma[<span class="hljs-number">0</span>];<br>		sigma[<span class="hljs-number">0</span>] = sigma[<span class="hljs-number">1</span>];<br>		sigma[<span class="hljs-number">1</span>] = temp;<br><br>		SwapColumn(U, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>		SwapColumn(V, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(sigma[<span class="hljs-number">1</span>]) &lt; <span class="hljs-built_in">abs</span>(sigma[<span class="hljs-number">2</span>]))<br>		&#123;<br>			temp = sigma[<span class="hljs-number">1</span>];<br>			sigma[<span class="hljs-number">1</span>] = sigma[<span class="hljs-number">2</span>];<br>			sigma[<span class="hljs-number">2</span>] = temp;<br><br>			SwapColumn(U, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>			SwapColumn(V, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>);<br>		&#125;<br>		<span class="hljs-keyword">else</span><br>		&#123;<br>			FlipSignColumn(U, <span class="hljs-number">2</span>);<br>			FlipSignColumn(V, <span class="hljs-number">2</span>);<br>		&#125;<br><br>		<span class="hljs-keyword">if</span> (sigma[<span class="hljs-number">1</span>] &lt; <span class="hljs-number">0</span>)<br>		&#123;<br>			FlipSign(<span class="hljs-number">1</span>, U, sigma);<br>			FlipSign(<span class="hljs-number">2</span>, U, sigma);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// Function to solve for reduced top-left matrix</span><br>	<span class="hljs-type">void</span> SolveReducedTopLeft(<span class="hljs-keyword">inout</span> float3x3 B, <span class="hljs-keyword">inout</span> float3x3 U, <span class="hljs-keyword">inout</span> float3x3 V, <span class="hljs-keyword">inout</span> float3 sigma)<br>	&#123;<br>		<span class="hljs-type">float</span> s3 = B[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>];<br>		float2x2 top_left = float2x2(B[<span class="hljs-number">0</span>].xy, B[<span class="hljs-number">1</span>].xy);<br>		float2x2 U2, V2;<br>		float2 D2;<br>		SVD2x2(top_left, U2, D2, V2);<br><br>		float3x3 u3 = G3_12_Direct(U2[<span class="hljs-number">0</span>].x, U2[<span class="hljs-number">0</span>].y);<br>		float3x3 v3 = G3_12_Direct(V2[<span class="hljs-number">0</span>].x, V2[<span class="hljs-number">0</span>].y);<br><br>		U = mul(U, u3);<br>		V = mul(V, v3);<br><br>		sigma = float3(D2[<span class="hljs-number">0</span>], D2[<span class="hljs-number">1</span>], s3);<br>	&#125;<br><br>	<span class="hljs-comment">// Function to solve for reduced bottom-right matrix</span><br>	<span class="hljs-type">void</span> SolveReducedBotRight(<span class="hljs-keyword">inout</span> float3x3 B, <span class="hljs-keyword">inout</span> float3x3 U, <span class="hljs-keyword">inout</span> float3x3 V, <span class="hljs-keyword">inout</span> float3 sigma)<br>	&#123;<br>		<span class="hljs-type">float</span> s1 = B[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>];<br>		float2x2 botRight = float2x2(B[<span class="hljs-number">1</span>].yz, B[<span class="hljs-number">2</span>].yz);<br>		float2x2 U2, V2;<br>		float2 D2;<br>		SVD2x2(botRight, U2, D2, V2);<br><br>		float3x3 u3 = G3_23_Direct(U2[<span class="hljs-number">0</span>].x, U2[<span class="hljs-number">0</span>].y);<br>		float3x3 v3 = G3_23_Direct(V2[<span class="hljs-number">0</span>].x, V2[<span class="hljs-number">0</span>].y);<br><br>		U = mul(U, u3);<br>		V = mul(V, v3);<br><br>		sigma = float3(s1, D2[<span class="hljs-number">0</span>], D2[<span class="hljs-number">1</span>]);<br>	&#125;<br>	<span class="hljs-comment">// Function for post-processing</span><br>	<span class="hljs-type">void</span> PostProcess(float3x3 B, <span class="hljs-keyword">inout</span> float3x3 U,<span class="hljs-keyword">out</span> float3 sigma, <span class="hljs-keyword">inout</span> float3x3 V, <span class="hljs-type">float</span> alpha1, <span class="hljs-type">float</span> alpha2, <span class="hljs-type">float</span> alpha3, <span class="hljs-type">float</span> beta1, <span class="hljs-type">float</span> beta2, <span class="hljs-type">float</span> gamma1, <span class="hljs-type">float</span> gamma2, <span class="hljs-type">float</span> tao)<br>	&#123;<br><br>		<span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(beta2) &lt;= tao)<br>		&#123;<br>			SolveReducedTopLeft(B, U, V, sigma);<br>			SortWithTopLeft(U, sigma, V);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(beta1) &lt;= tao)<br>		&#123;<br>			SolveReducedBotRight(B, U, V, sigma);<br>			SortWithBotRight(U, sigma, V);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(alpha2) &lt;= tao)<br>		&#123;<br>			float3x3 G = G3_23(B[<span class="hljs-number">1</span>].z, B[<span class="hljs-number">2</span>].z, <span class="hljs-literal">false</span>);<br>			B = mul(<span class="hljs-built_in">transpose</span>(G), B);<br>			U = mul(U, G);<br>			SolveReducedTopLeft(B, U, V, sigma);<br>			SortWithTopLeft(U, sigma, V);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(alpha3) &lt;= tao)<br>		&#123;<br>			float3x3 G = G3_23(B[<span class="hljs-number">1</span>].y, B[<span class="hljs-number">1</span>].z);<br>			B = mul(B, G);<br>			V = mul(V, G);<br>			G = G3_13(B[<span class="hljs-number">0</span>].x, B[<span class="hljs-number">0</span>].z);<br>			B = mul(B, G);<br>			V = mul(V, G);<br>			SolveReducedTopLeft(B, U, V, sigma);<br>			SortWithTopLeft(U, sigma, V);<br>		&#125;<br>		<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">abs</span>(alpha1) &lt;= tao)<br>		&#123;<br>			float3x3 G = G3_12(B[<span class="hljs-number">0</span>].y, B[<span class="hljs-number">1</span>].y, <span class="hljs-literal">false</span>);<br>			B = mul(<span class="hljs-built_in">transpose</span>(G), B);<br>			U = mul(U, G);<br>			G = G3_13(B[<span class="hljs-number">0</span>].z, B[<span class="hljs-number">2</span>].z, <span class="hljs-literal">false</span>);<br>			B = mul(<span class="hljs-built_in">transpose</span>(G), B);<br>			U = mul(U, G);<br>			SolveReducedBotRight(B, U, V, sigma);<br>			SortWithBotRight(U, sigma, V);<br>		&#125;<br>	&#125;<br><br>	<span class="hljs-comment">// Function for SVD of a 3x3 matrix</span><br>	<span class="hljs-type">void</span> svd(float3x3 A, <span class="hljs-keyword">out</span> float3x3 U, <span class="hljs-keyword">out</span> float3 Sigma, <span class="hljs-keyword">out</span> float3x3 V)<br>	&#123;<br>		U = float3x3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br>		V = float3x3(<span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>);<br><br>		Bidiag(U, A, V);<br>		float3x3 B = A;<br><br>		<span class="hljs-type">float</span> alpha1 = B[<span class="hljs-number">0</span>].x;<br>		<span class="hljs-type">float</span> alpha2 = B[<span class="hljs-number">1</span>].y;<br>		<span class="hljs-type">float</span> alpha3 = B[<span class="hljs-number">2</span>].z;<br>		<span class="hljs-type">float</span> beta1 = B[<span class="hljs-number">0</span>].y;<br>		<span class="hljs-type">float</span> beta2 = B[<span class="hljs-number">1</span>].z;<br>		<span class="hljs-type">float</span> gamma1 = alpha1 * beta1;<br>		<span class="hljs-type">float</span> gamma2 = alpha2 * beta2;<br><br>		<span class="hljs-type">float</span> tol = <span class="hljs-number">128</span> * EPSILON;<br>		<span class="hljs-type">float</span> tao = tol * <span class="hljs-built_in">max</span>(<span class="hljs-number">0.5</span> * FrobeniusNorm(B), <span class="hljs-number">1</span>);<br>		<span class="hljs-type">int</span> Num = <span class="hljs-number">0</span>;<br>		<span class="hljs-keyword">while</span> (<span class="hljs-built_in">abs</span>(beta1) &gt; tao &amp;&amp; <span class="hljs-built_in">abs</span>(beta2) &gt; tao &amp;&amp;<br>			   <span class="hljs-built_in">abs</span>(alpha1) &gt; tao &amp;&amp; <span class="hljs-built_in">abs</span>(alpha2) &gt; tao &amp;&amp; <span class="hljs-built_in">abs</span>(alpha3) &gt; tao)<br>		&#123;<br>            <span class="hljs-keyword">if</span>(Num&gt;<span class="hljs-number">50</span>)<br>            &#123;<br>                <span class="hljs-keyword">break</span>;<br>            &#125;<br>			<span class="hljs-type">float</span> a1 = alpha2 * alpha2 + beta1 * beta1;<br>			<span class="hljs-type">float</span> a2 = alpha3 * alpha3 + beta1 * beta1;<br>			<span class="hljs-type">float</span> b1 = gamma1;<br>			<span class="hljs-type">float</span> d = (a1 - a2) * <span class="hljs-number">0.5</span>;<br>			<span class="hljs-type">float</span> mu = (b1 * b1) / (<span class="hljs-built_in">abs</span>(d) + <span class="hljs-built_in">sqrt</span>(d * d + b1 * b1));<br><br>			<span class="hljs-keyword">if</span> (d &lt; <span class="hljs-number">0</span>)<br>				mu = -mu;<br><br>			mu = a2 - mu;<br>			float3x3 G = G3_12(alpha1 * alpha1 - mu, gamma1);<br>			B = mul(B, G);<br>			V = mul(V, G);<br>			ZeroChasing(U, B, V);<br><br>			alpha1 = B[<span class="hljs-number">0</span>].x;<br>			alpha2 = B[<span class="hljs-number">1</span>].y;<br>			alpha3 = B[<span class="hljs-number">2</span>].z;<br>			beta1 = B[<span class="hljs-number">0</span>].y;<br>			beta2 = B[<span class="hljs-number">1</span>].z;<br>			gamma1 = alpha1 * beta1;<br>			gamma2 = alpha2 * beta2;<br>            Num++;<br><br>		&#125;<br><br>		PostProcess(B, U,Sigma, V, alpha1, alpha2, alpha3, beta1, beta2, gamma1, gamma2, tao);<br><br>	&#125;<br>	<span class="hljs-type">void</span> ConverMatrix(float3x3 Inmat, <span class="hljs-keyword">out</span> float4x4 OutMat)<br>	&#123;<br>		OutMat =  float4x4(Inmat[<span class="hljs-number">0</span>].x,Inmat[<span class="hljs-number">0</span>].y,Inmat[<span class="hljs-number">0</span>].z,<span class="hljs-number">0</span>,<br>			Inmat[<span class="hljs-number">1</span>].x,Inmat[<span class="hljs-number">1</span>].y,Inmat[<span class="hljs-number">1</span>].z,<span class="hljs-number">0</span>,<br>			Inmat[<span class="hljs-number">2</span>].x,Inmat[<span class="hljs-number">2</span>].y,Inmat[<span class="hljs-number">2</span>].z,<span class="hljs-number">0</span>,<br>			<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">1</span>);<br><br>	&#125;<br>	<span class="hljs-type">void</span> ConverMatrix(float4x4 Inmat,<span class="hljs-keyword">out</span> float3x3 OutMat)<br>	&#123;<br>		OutMat =  float3x3(Inmat[<span class="hljs-number">0</span>].x,Inmat[<span class="hljs-number">0</span>].y,Inmat[<span class="hljs-number">0</span>].z,<br>			Inmat[<span class="hljs-number">1</span>].x,Inmat[<span class="hljs-number">1</span>].y,Inmat[<span class="hljs-number">1</span>].z,<br>			Inmat[<span class="hljs-number">2</span>].x,Inmat[<span class="hljs-number">2</span>].y,Inmat[<span class="hljs-number">2</span>].z);<br>	&#125;<br>&#125;;<br></code></pre></td></tr></table></figure><p></p><div class="tags"><a href="/tags/%E6%A8%A1%E6%8B%9F/" rel="tag"><i class="ic i-tag"></i> 模拟</a> <a href="/tags/%E6%96%87%E7%AB%A0/" rel="tag"><i class="ic i-tag"></i> 文章</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-12-30 13:58:17" itemprop="dateModified" datetime="2023-12-30T13:58:17+08:00">2023-12-30</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Natsuneko 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Natsuneko 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Natsuneko 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Natsuneko <i class="ic i-at"><em>@</em></i>夏猫</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2023/12/24/simulation/MPMSnow/" title="MPM 雪、海绵">http://example.com/2023/12/24/simulation/MPMSnow/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/12/24/simulation/MPMWater/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3&#x2F;wallpaperLibrary&#x2F;raw&#x2F;main&#x2F;wallhaven-pkpjlp.jpg" title="MPM水"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 文章</span><h3>MPM水</h3></a></div><div class="item right"><a href="/2023/12/25/simulation/%E6%B5%81%E4%BD%93%E5%8A%9B%E5%AD%A6%E5%9F%BA%E7%A1%80/%E5%A5%A5%E9%AB%98%E5%85%AC%E5%BC%8F/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3&#x2F;wallpaperLibrary&#x2F;raw&#x2F;main&#x2F;wallhaven-gp8y37.jpg" title="奥高公式"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 模拟笔记</span><h3>奥高公式</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mpm%E9%9B%AA-%E6%B5%B7%E7%BB%B5"><span class="toc-number">1.</span> <span class="toc-text">MPM 雪、海绵</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%9B%AA"><span class="toc-number">3.</span> <span class="toc-text">雪</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#niagara%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.1.</span> <span class="toc-text">Niagara 实现</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BC%B9%E6%80%A7%E4%BD%93"><span class="toc-number">4.</span> <span class="toc-text">弹性体</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#svd%E4%BB%A3%E7%A0%81"><span class="toc-number">5.</span> <span class="toc-text">SVD 代码</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/09/29/color/" rel="bookmark" title="【VFX】浅析特效设计与色彩（1）">【VFX】浅析特效设计与色彩（1）</a></li><li><a href="/2021/10/07/color2/" rel="bookmark" title="【VFX】浅析特效设计与色彩（2）">【VFX】浅析特效设计与色彩（2）</a></li><li><a href="/2022/02/12/Niagara/" rel="bookmark" title="【UE4】新手特效向Niagara常见问题解决与小技巧分享（不定期更新）">【UE4】新手特效向Niagara常见问题解决与小技巧分享（不定期更新）</a></li><li><a href="/2022/04/08/Softbody/" rel="bookmark" title="【UE5】在niagara实现Softbody dynamic">【UE5】在niagara实现Softbody dynamic</a></li><li><a href="/2022/06/26/MultiPass/" rel="bookmark" title="【虚幻引擎】在UE实现多Pass Renderer">【虚幻引擎】在UE实现多Pass Renderer</a></li><li><a href="/2022/11/07/DualKawaseBlur/" rel="bookmark" title="【UE4/UE5】拓展后期pass实现DualKawaseBlur">【UE4/UE5】拓展后期pass实现DualKawaseBlur</a></li><li><a href="/2022/11/29/oit/" rel="bookmark" title="【UE5】浅析UE5.1OIT半透明排序算法">【UE5】浅析UE5.1OIT半透明排序算法</a></li><li><a href="/2023/02/17/simulation/%E5%9F%BA%E4%BA%8ELBM(Lattice%20Boltzmann%20Method)%E6%B5%81%E4%BD%93%E6%A8%A1%E6%8B%9F/" rel="bookmark" title="基于LBM(Lattice Boltzmann Method)流体模拟">基于LBM(Lattice Boltzmann Method)流体模拟</a></li><li class="active"><a href="/2023/12/24/simulation/MPMSnow/" rel="bookmark" title="MPM雪、海绵">MPM雪、海绵</a></li><li><a href="/2023/12/24/simulation/MPMWater/" rel="bookmark" title="MPM水">MPM水</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Natsuneko" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Natsuneko</p><div class="description" itemprop="description">主要分享关于 ue 或者 TA 的知识，也或者分享点自己想写的东西，作品什么的</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">66</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">17</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL05hdHN1bmVrbzM=" title="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9uYXRzdW5la29zYW4=" title="https:&#x2F;&#x2F;twitter.com&#x2F;natsunekosan"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9OYXRzdW5la28=" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;Natsuneko"><i class="ic i-zhihu"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cucmVhbHRpbWUueHl6Lw=="><i class="ic i-heart"></i>friends</span></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/12/24/simulation/MPMWater/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/12/25/simulation/%E6%B5%81%E4%BD%93%E5%8A%9B%E5%AD%A6%E5%9F%BA%E7%A1%80/%E5%A5%A5%E9%AB%98%E5%85%AC%E5%BC%8F/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Natsuneko @ Natsu neko</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">339k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:08</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/12/24/simulation/MPMSnow/",favicon:{show:"（●´3｀●）感觉还不错把",hide:"____________________________________"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,copy_tex:!0,katex:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(_){return _.includes("#")},function(_){return new RegExp(LOCAL.path+"$").test(_)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>