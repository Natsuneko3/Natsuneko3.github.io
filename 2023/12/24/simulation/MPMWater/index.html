<!DOCTYPE html><html lang="ch"><head><link rel="stylesheet" href="/css/bilicard.css"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="夏猫" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="夏猫" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="夏猫" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="模拟,文章"><link rel="canonical" href="http://example.com/2023/12/24/simulation/MPMWater/"><meta name="description" content="# MPM 水 # 简介 对于流体模拟来说有两种视界，一种是拉格朗日视角一种是欧拉视角，  拉格朗日视角就是把物理量存在粒子上，因为粒子是自由移动，所以很容易做 advection，做起动量守恒很容易，但粒子是离散化，使得检测周围邻居变得异常困难，但可以用哈希结构数据储存来检索，就像 niagara neighbor 3d 欧拉视角则是把世界分为一个个 grid，所有物理量在都是在 Grid 上，"><meta property="og:type" content="article"><meta property="og:title" content="MPM 水"><meta property="og:url" content="http://example.com/2023/12/24/simulation/MPMWater/index.html"><meta property="og:site_name" content="夏猫"><meta property="og:description" content="# MPM 水 # 简介 对于流体模拟来说有两种视界，一种是拉格朗日视角一种是欧拉视角，  拉格朗日视角就是把物理量存在粒子上，因为粒子是自由移动，所以很容易做 advection，做起动量守恒很容易，但粒子是离散化，使得检测周围邻居变得异常困难，但可以用哈希结构数据储存来检索，就像 niagara neighbor 3d 欧拉视角则是把世界分为一个个 grid，所有物理量在都是在 Grid 上，"><meta property="og:locale"><meta property="og:image" content="https://pic1.zhimg.com/80/v2-0d309551850d112f81f4051c9750a784_1440w.jpg"><meta property="og:image" content="https://pic3.zhimg.com/80/v2-86cfc2dab0b0b5d1272ecb779587c91e_1440w.webp"><meta property="og:image" content="https://pic1.zhimg.com/80/v2-88f270d40eb60e9cd79b42016bd15fdc_1440w.webp"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-7ef74b2a9a1f493de74e36f71a47d2ac_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-d423f3cf45c0b0c828bfc1169d416851_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-f03d5a118ca8ffd4672da68ffbcc45ea_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-229b25e581200e16ef38aa59aeb228f0_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-22686bbc34c85b103d92c57ed1a8a53f_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-0945fa51c723f78144ce20bc43582a6d_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-c8ef84a9f1d21e1bd9ba02d56f32e013_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-97dddfc76a2d55d66244e0e93ce997e4_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-bd21270d3d3e3e27f65946c562093af9_1440w.png"><meta property="og:image" content="http://example.com/2023/12/24/simulation/MPMWater/MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-496faff3e90cfa377765ed7d354768ff_1440w.png"><meta property="article:published_time" content="2023-12-24T04:00:00.000Z"><meta property="article:modified_time" content="2023-12-30T05:58:27.420Z"><meta property="article:author" content="Natsuneko"><meta property="article:tag" content="模拟"><meta property="article:tag" content="文章"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://pic1.zhimg.com/80/v2-0d309551850d112f81f4051c9750a784_1440w.jpg"><meta name="twitter:creator" content="@natsunekosan"><title>MPM 水 - 文章 | Natsu neko = 夏猫 = 嵐です！</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">MPM 水</h1><div class="meta"><span class="item" title="创建时间：2023-12-24 12:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2023-12-24T12:00:00+08:00">2023-12-24</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>12k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>11 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Natsu neko</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-x17q6v.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-6kg5d7.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-dpe3xm.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/pia01322.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-28ggwy.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-j5vgzw.png"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E6%96%87%E7%AB%A0/" itemprop="item" rel="index" title="分类于 文章"><span itemprop="name">文章</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="ch"><link itemprop="mainEntityOfPage" href="http://example.com/2023/12/24/simulation/MPMWater/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Natsuneko"><meta itemprop="description" content="嵐です！, 主要分享关于 ue 或者 TA 的知识，也或者分享点自己想写的东西，作品什么的"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="夏猫"></span><div class="body md" itemprop="articleBody"><h1 id="mpm水"><a class="anchor" href="#mpm水">#</a> MPM 水</h1><h2 id="简介"><a class="anchor" href="#简介">#</a> <strong>简介</strong></h2><p>对于流体模拟来说有两种视界，一种是拉格朗日视角一种是欧拉视角，</p><ul><li>拉格朗日视角就是把物理量存在粒子上，因为粒子是自由移动，所以很容易做 advection，做起动量守恒很容易，但粒子是离散化，使得检测周围邻居变得异常困难，但可以用哈希结构数据储存来检索，就像 niagara neighbor 3d</li><li>欧拉视角则是把世界分为一个个 grid，所有物理量在都是在 Grid 上，因为是 Grid 所以很容易求出 Projection，就是压强，但欧拉 grid 面对 advection 很难，模拟的时候回流能量损失，流体看起来非常粘</li></ul><p>而 MPM 质点法就是混合了拉格朗日视角和欧拉视角，他由 FLIP 方法的扩展而提出的，FLIP 就是现在官方 Niagara 中所使用的模拟方法。而 MPM 的好处是实现起来很简单，可以模拟各种离散材料，并且可以让他们互相作用，例如水和沙子之间互相作用，或者 softbody 和 water 和雪之间的互相作用，在模拟水这一块，FLIP 用的是隐式积分，要几十次迭代求解压力场才能收敛，而且需要求多个 Grid 求 Δ，MPM 在运行速率比 FLIP 的快一点。</p><p>测试两个系统同时运行一秒后，在 50 个格子的精度下，spawn rate 是 20000 情况下，压力场迭代 200 次官方水是 1.81 秒，MLS-MPM 是 1.26 秒</p><p><img data-src="https://pic1.zhimg.com/80/v2-0d309551850d112f81f4051c9750a784_1440w.jpg" alt="https://pic1.zhimg.com/80/v2-0d309551850d112f81f4051c9750a784_1440w.jpg"></p><p>官方 FLIP 水</p><p><img data-src="https://pic3.zhimg.com/80/v2-86cfc2dab0b0b5d1272ecb779587c91e_1440w.webp" alt="https://pic3.zhimg.com/80/v2-86cfc2dab0b0b5d1272ecb779587c91e_1440w.webp"></p><h1 id="mpm"><a class="anchor" href="#mpm">#</a> <strong>MPM</strong></h1><p>PIC（particle in cell）是在 MPM 框架下最初提出来的 method，MPM simulation 大致实现的步骤就是先把粒子插值分配到周围 Grid 上（particle to grid），然后在 Grid 上计算力和各种互相作用力，然后再插值回粒子求出速度（ grid to particle）</p><h2 id="pic-particle-in-cell"><a class="anchor" href="#pic-particle-in-cell">#</a> <strong>PIC - Particle In Cell</strong></h2><p>先把粒子通过 B-Spline 插值到 3x3，一般就是用 Quadratic 足够 smooth</p><p>这是代码，看起来简单明了，这个过程就叫 P2G，其中插值不是以当前点为中心，而且粒子点所在的 3x3 区块的右下角，所以 base 才有 - 0.5</p><p>然后 Grid 上动量除于 Mass 就是速度了</p><p><img data-src="https://pic1.zhimg.com/80/v2-88f270d40eb60e9cd79b42016bd15fdc_1440w.webp" alt="https://pic1.zhimg.com/80/v2-88f270d40eb60e9cd79b42016bd15fdc_1440w.webp"></p><p>最后把网格速度重新收集到粒子上，再 B-Spline 插值回去</p><p>但是这个 method 有个问题就是有能量损耗，，平移没有耗散，但拉式，旋转，剪切都是有耗散的，运动一会就不动了，原因是信息的丢失，在原来二维的 Grid 上有 18 个自由度，3x3 个格子和各个 xy，但传播到粒子上就只有两个自由度，就是只有 xy。</p><p>解决办法就是给粒子记录更多信息，就是 APIC，多了一 C 矩阵，记录 x y 方向的拉伸、剪切旋转量、剪切量</p><p>还有个方法就是只传输 Δx 信息，就是对格子求导得到最终速度给粒子，就是 FLIP</p><h2 id="apic-affine-particle-in-cell"><a class="anchor" href="#apic-affine-particle-in-cell">#</a> <strong>APIC-affine particle in cell</strong></h2><p>先看看 particle to grid 的公式，</p><p>将每个粒子的质量分配到该粒子周围的网格上，并使用粒子的速度及 affine 矩阵计算每个网格的速度。</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mo stretchy="false">(</mo><mi>m</mi><mtext mathvariant="bold">v</mtext><msubsup><mo stretchy="false">)</mo><mi>i</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><munder><mo>∑</mo><mi>p</mi></munder><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>p</mi></mrow></msub><mo stretchy="false">[</mo><msub><mi>m</mi><mi>p</mi></msub><msubsup><mtext mathvariant="bold">v</mtext><mi>p</mi><mi>n</mi></msubsup><mo>+</mo><msub><mi>m</mi><mi>p</mi></msub><msubsup><mtext mathvariant="bold">C</mtext><mi>p</mi><mi>n</mi></msubsup><mo stretchy="false">(</mo><msub><mtext mathvariant="bold">x</mtext><mi>i</mi></msub><mo>−</mo><msubsup><mtext mathvariant="bold">x</mtext><mi>p</mi><mi>n</mi></msubsup><mo stretchy="false">)</mo><mo stretchy="false">]</mo></mrow><annotation encoding="application/x-tex">(m\textbf{v} )_i^{n+1}=\sum_pw_{i,p} [m_p \textbf{v}_p^{n}+m_p\textbf{C}_p^n(\textbf{x}_i-\textbf{x}_p^n)]</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.131103em;vertical-align:-.266995em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord text"><span class="mord textbf">v</span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-2.433005em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.266995em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.4361180000000004em;vertical-align:-1.386113em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em"><span style="top:-1.8999949999999999em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.050005em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.386113em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.02691em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mopen">[</span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord textbf">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.714392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.133108em;vertical-align:-.383108em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord textbf">C</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.133108em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.714392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose">]</span></span></span></span></span></p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mi>m</mi><mi>i</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><munder><mo>∑</mo><mi>p</mi></munder><msub><mi>m</mi><mi>p</mi></msub><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">m_i^{n+1}=\sum_pm_pw_{i,p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.131103em;vertical-align:-.266995em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-2.433005em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.266995em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.4361180000000004em;vertical-align:-1.386113em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em"><span style="top:-1.8999949999999999em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.050005em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.386113em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.02691em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span></span></p><p>其中， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>p</mi></mrow></msub></mrow><annotation encoding="application/x-tex">w_{i,p}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.716668em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.02691em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 表示点 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal">p</span></span></span></span> 对网格 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 的贡献权重， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mtext mathvariant="bold">C</mtext><mi>p</mi><mi>n</mi></msubsup></mrow><annotation encoding="application/x-tex">\textbf{C}_p^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.12351em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">C</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span></span></span></span> 表示 affine 矩阵，下标<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.625em;vertical-align:-.19444em"></span><span class="mord mathnormal">p</span></span></span></span> 的意思就是粒子，下标<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.65952em;vertical-align:0"></span><span class="mord mathnormal">i</span></span></span></span> 就是网格位置，那么 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mtext mathvariant="bold">x</mtext><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">\textbf{x}_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.59444em;vertical-align:-.15em"></span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 就是 3x3 的 Base 点</p><p>对于 APIC 的实现公式很简单，但其推导及其复杂，所以就不写推导了</p><p>APIC 在 PIC 上多加了一个矩阵和 affine</p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-7ef74b2a9a1f493de74e36f71a47d2ac_1440w.png" alt="v2-7ef74b2a9a1f493de74e36f71a47d2ac_1440w.png"></p><p>然后 Grid to Particle 公式就是下面，同时为每个粒子计算 affine 矩阵。</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mtext mathvariant="bold">v</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>p</mi></mrow></msub><msubsup><mtext mathvariant="bold">v</mtext><mi>i</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mspace linebreak="newline"></mspace><msubsup><mtext mathvariant="bold">C</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><mfrac><mn>4</mn><mrow><mi mathvariant="normal">Δ</mi><msup><mi>x</mi><mn>2</mn></msup></mrow></mfrac><munder><mo>∑</mo><mi>i</mi></munder><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>p</mi></mrow></msub><msubsup><mtext mathvariant="bold">v</mtext><mi>i</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo stretchy="false">(</mo><msub><mtext mathvariant="bold">x</mtext><mi>i</mi></msub><mo>−</mo><msubsup><mtext mathvariant="bold">x</mtext><mi>p</mi><mi>n</mi></msubsup><msup><mo stretchy="false">)</mo><mtext mathvariant="bold">T</mtext></msup><mspace linebreak="newline"></mspace><msubsup><mtext mathvariant="bold">x</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><msubsup><mtext mathvariant="bold">x</mtext><mi>p</mi><mi>n</mi></msubsup><mo>+</mo><mi mathvariant="normal">Δ</mi><mi>t</mi><msubsup><mtext mathvariant="bold">v</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex">\textbf{v}_p^{n+1}=\sum_iw_{i,p}\textbf{v}_i^{n+1} \\\textbf{C}_p^{n+1}=\frac{4}{\Delta x^2}\sum_iw_{i,p}\textbf{v}_i^{n+1}(\textbf x_i-\textbf x_p^n)^{\textbf T} \\\textbf{x}_p^{n+1}=\textbf{x}_p^n+\Delta t \textbf{v}_p^{n+1} \\</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.2472159999999999em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.864108em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.327674em;vertical-align:-1.277669em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em"><span style="top:-1.872331em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.050005em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.02691em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord textbf">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-2.433005em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.266995em"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.273226em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">C</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.890118em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.13901em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.599109em;vertical-align:-1.277669em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">Δ</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.740108em"><span style="top:-2.9890000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">4</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em"><span style="top:-1.872331em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.050005em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.277669em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.02691em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord textbf">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-2.433005em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.266995em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.2763849999999999em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.714392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8932769999999999em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord textbf mtight">T</span></span></span></span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.2472159999999999em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.864108em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1.0975000000000001em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.714392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.2472159999999999em;vertical-align:-.383108em"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord text"><span class="mord textbf">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.864108em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span></span><span class="mspace newline"></span></span></span></span></p><p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mtext mathvariant="bold">v</mtext><mi>i</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo stretchy="false">(</mo><msub><mtext mathvariant="bold">x</mtext><mi>i</mi></msub><mo>−</mo><msubsup><mtext mathvariant="bold">x</mtext><mi>p</mi><mi>n</mi></msubsup><msup><mo stretchy="false">)</mo><mtext mathvariant="bold">T</mtext></msup></mrow><annotation encoding="application/x-tex">\textbf{v}_i^{n+1}(\textbf x_i-\textbf x_p^n)^{\textbf T}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.131103em;vertical-align:-.276864em"></span><span class="mord"><span class="mord text"><span class="mord textbf">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.854239em"><span style="top:-2.4231360000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.1031310000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.276864em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.226385em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.664392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8432769999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord text mtight"><span class="mord textbf mtight">T</span></span></span></span></span></span></span></span></span></span></span></span></span> 就是 V 对 Base Grid 的 outer-product 外积，在这里说一下，国内很多中文文章把 crose 叉积当成外积用，写出去误导了很多人，但百度百科和维基是对的，在线性代数中一般指两个向量的张量积，两个向量外积是个矩阵，是向量 A 乘向量 B 的转置</p><p>这是 APIC 论文，有兴趣可以读读</p><p><span class="exturl" data-url="aHR0cHM6Ly93d3cubWF0aC51Y2xhLmVkdS9+Y2ZmamlhbmcvcmVzZWFyY2gvYXBpYy9wYXBlci5wZGY=">https://www.math.ucla.edu/~cffjiang/research/apic/paper.pdf</span></p><h2 id="mls-mpm"><a class="anchor" href="#mls-mpm">#</a> <strong>MLS-MPM</strong></h2><p>那么现在就到本文在 Niagara 实现的方法，就是在 APIC 上进行了改进，在 APIC 上多了个 stress，称为 Cauchy Stress，起到的作用是表现抵抗压缩的力，在 P2G 公式是这样的</p><p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><mo stretchy="false">(</mo><mtext mathvariant="bold">I</mtext><mo>+</mo><mi mathvariant="normal">Δ</mi><mi>t</mi><msubsup><mtext mathvariant="bold">C</mtext><mi>p</mi><mi>n</mi></msubsup><mo stretchy="false">)</mo><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mi>n</mi></msubsup><mspace linebreak="newline"></mspace><mo stretchy="false">(</mo><mi>m</mi><mtext mathvariant="bold">v</mtext><msubsup><mo stretchy="false">)</mo><mi>i</mi><mi>n</mi></msubsup><mo>=</mo><munder><mo>∑</mo><mi>p</mi></munder><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>p</mi></mrow></msub><mrow><mo fence="true">{</mo><msub><mi>m</mi><mi>p</mi></msub><msubsup><mtext mathvariant="bold">v</mtext><mi>p</mi><mi>n</mi></msubsup><mo>+</mo><mrow><mo fence="true">[</mo><msub><mi>m</mi><mi>p</mi></msub><msubsup><mtext mathvariant="bold">C</mtext><mi>p</mi><mi>n</mi></msubsup><mo>−</mo><mfrac><mrow><mn>4</mn><mi mathvariant="normal">Δ</mi><mi>t</mi></mrow><mrow><mi mathvariant="normal">Δ</mi><msup><mi>x</mi><mn>2</mn></msup></mrow></mfrac><munder><mo>∑</mo><mi>p</mi></munder><msubsup><mi>V</mi><mi>p</mi><mn>0</mn></msubsup><mtext mathvariant="bold">P</mtext><mo stretchy="false">(</mo><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo stretchy="false">)</mo><mo stretchy="false">(</mo><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><msup><mo stretchy="false">)</mo><mi>T</mi></msup><mo fence="true">]</mo></mrow><mo stretchy="false">(</mo><msub><mtext mathvariant="bold">x</mtext><mi>i</mi></msub><mo>−</mo><msubsup><mtext mathvariant="bold">x</mtext><mi>p</mi><mi>n</mi></msubsup><mo stretchy="false">)</mo><mo fence="true">}</mo></mrow><mspace linebreak="newline"></mspace><msubsup><mi>m</mi><mi>i</mi><mrow><mi>n</mi><mo>+</mo><mn>1</mn></mrow></msubsup><mo>=</mo><munder><mo>∑</mo><mi>p</mi></munder><msub><mi>m</mi><mi>p</mi></msub><msub><mi>w</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>j</mi></mrow></msub><mspace linebreak="newline"></mspace></mrow><annotation encoding="application/x-tex">\textbf{F}_p^{n+1}=(\textbf I+\Delta t \textbf C_p^n)\textbf{F}_p^{n} \\(m\textbf v)_i^{n}=\sum_pw_{i,p} \left\{ m_p \textbf v_p^n+\left[m_p\textbf C_p^n-\frac{4\Delta t}{\Delta x^2}\sum_p V_p^0\textbf P(\textbf F_p^{n+1})(\textbf F_p^{n+1})^T \right](\textbf x_i-\textbf x_p^n)\right\}\\ m_i^{n+1}=\sum_pm_pw_{i,j}\\</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.273226em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.890118em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.13901em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord text"><span class="mord textbf">I</span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span></span><span class="base"><span class="strut" style="height:1.133108em;vertical-align:-.383108em"></span><span class="mord">Δ</span><span class="mord mathnormal">t</span><span class="mord"><span class="mord text"><span class="mord textbf">C</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1em;vertical-align:-.25em"></span><span class="mopen">(</span><span class="mord mathnormal">m</span><span class="mord text"><span class="mord textbf">v</span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.7143919999999999em"><span style="top:-2.4530000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.247em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:3.136113em;vertical-align:-1.386113em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em"><span style="top:-1.8999949999999999em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.050005em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.386113em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.02691em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">p</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="minner"><span class="mopen delimcenter" style="top:0"><span class="delimsizing size4">{</span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord textbf">v</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.714392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">+</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="minner"><span class="mopen delimcenter" style="top:0"><span class="delimsizing size4">[</span></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord text"><span class="mord textbf">C</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.36033em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">Δ</span><span class="mord"><span class="mord mathnormal">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.740108em"><span style="top:-2.9890000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">4</span><span class="mord">Δ</span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em"><span style="top:-1.8999949999999999em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.050005em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.386113em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.864108em"><span style="top:-2.4530000000000003em;margin-left:-.22222em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mord text"><span class="mord textbf">P</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.890118em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.13901em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.890118em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.13901em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8913309999999999em"><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:.13889em">T</span></span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0"><span class="delimsizing size4">]</span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:.2222222222222222em"></span><span class="mord"><span class="mord text"><span class="mord textbf">x</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.714392em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1130000000000004em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose">)</span><span class="mclose delimcenter" style="top:0"><span class="delimsizing size4">}</span></span></span></span><span class="mspace newline"></span><span class="base"><span class="strut" style="height:1.131103em;vertical-align:-.266995em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.8641079999999999em"><span style="top:-2.433005em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span><span style="top:-3.113em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span><span class="mbin mtight">+</span><span class="mord mtight">1</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.266995em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:.2777777777777778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:.2777777777777778em"></span></span><span class="base"><span class="strut" style="height:2.4361180000000004em;vertical-align:-1.386113em"></span><span class="mop op-limits"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.0500050000000003em"><span style="top:-1.8999949999999999em;margin-left:0"><span class="pstrut" style="height:3.05em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.050005em"><span class="pstrut" style="height:3.05em"></span><span><span class="mop op-symbol large-op">∑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.386113em"><span></span></span></span></span></span><span class="mspace" style="margin-right:.16666666666666666em"></span><span class="mord"><span class="mord mathnormal">m</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:0;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal" style="margin-right:.02691em">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.311664em"><span style="top:-2.5500000000000003em;margin-left:-.02691em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight" style="margin-right:.05724em">j</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span><span class="mspace newline"></span></span></span></span></p><p>其中，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mi>n</mi></msubsup></mrow><annotation encoding="application/x-tex">\textbf F_p^n</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.12351em;vertical-align:-.383108em"></span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">n</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span></span></span></span> 表示形变梯度，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mtext mathvariant="bold">P</mtext><mo stretchy="false">(</mo><msubsup><mtext mathvariant="bold">F</mtext><mi>p</mi><mi>n</mi></msubsup><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">\textbf P(\textbf F_p^{n})</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.133108em;vertical-align:-.383108em"></span><span class="mord text"><span class="mord textbf">P</span></span><span class="mopen">(</span><span class="mord"><span class="mord text"><span class="mord textbf">F</span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.740402em"><span style="top:-2.4530000000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span><span style="top:-3.1390100000000003em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">n</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.383108em"><span></span></span></span></span></span></span><span class="mclose">)</span></span></span></span> 表示 PK1 数，MLS-MPM 方法除了处理流体，还会用来解弹性物体，所以不再有投影步骤，所以他和 APIC 的区别只有 P2G 过程。</p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-d423f3cf45c0b0c828bfc1169d416851_1440w.png" alt="v2-d423f3cf45c0b0c828bfc1169d416851_1440w.png"></p><h2 id="mls-mpm公式推导"><a class="anchor" href="#mls-mpm公式推导">#</a> <strong>MLS-MPM 公式推导</strong></h2><p>那么中间那一项是怎么得出来的呢，首先要求出当前点的动量，那么该点所受到一定是冲量叠加上去的，假设我们用超弹性材料模型</p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-f03d5a118ca8ffd4672da68ffbcc45ea_1440w.png" alt="v2-f03d5a118ca8ffd4672da68ffbcc45ea_1440w.png"></p><p>而所受到的的力就是总体弹性势能求导，其中 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>ψ</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">\psi_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.980548em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.03588em">ψ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:-.03588em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 是粒子受到的弹性势能密度， <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>p</mi></msub></mrow><annotation encoding="application/x-tex">V_p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.969438em;vertical-align:-.286108em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.15139200000000003em"><span style="top:-2.5500000000000003em;margin-left:-.22222em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.286108em"><span></span></span></span></span></span></span></span></span></span> 就是粒子初始体积，2D 就是 Δx 的平方，3D 模拟就是立方，则 U 就是痛的弹性势能，但在 MLS-MPM 他的 Grid 是不会变的，那么需要用另一种方法法。</p><p>假设我们 Particle 向前移动 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.1132em">τ</span></span></span></span> ，而 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.1132em">τ</span></span></span></span> 无限接近于 0，而黄色的 X 就是形变 Grid，那么把所有的东西替换成我们的变量，那么当前点所受到的势能就是公式 5。现在因为 MLS-MPM 的 Grid 是不变的，所有转化成对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>V</mi><mi>i</mi></msub></mrow><annotation encoding="application/x-tex">V_i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.83333em;vertical-align:-.15em"></span><span class="mord"><span class="mord mathnormal" style="margin-right:.22222em">V</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:.31166399999999994em"><span style="top:-2.5500000000000003em;margin-left:-.22222em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:.15em"><span></span></span></span></span></span></span></span></span></span> 求导，所以需要除于 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.1132em">τ</span></span></span></span> ，然后用链式法则把（6）变成（7）拆成 3 项，而这三项就可以定义，那么现在可以发现红色那一项就是 PK1 stress 了，蓝色项就是事先定于的形变矩阵，绿色对 C 求导就是直接是 APIC 中的 C，做完后，就可以把 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>τ</mi></mrow><annotation encoding="application/x-tex">\tau</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.43056em;vertical-align:0"></span><span class="mord mathnormal" style="margin-right:.1132em">τ</span></span></span></span> 消除掉，于是就得到 MLS-MPM 的公式了</p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-229b25e581200e16ef38aa59aeb228f0_1440w.png" alt="v2-229b25e581200e16ef38aa59aeb228f0_1440w.png"></p><p>这是 MLS-MPM 原论文，由<span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9pdGVyYXRvcg==">胡渊鸣</span> 大佬写的，也可以看一下<span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMVpLNDExSDdIYz9wPTc="> Games201</span></p><h1 id="niagara实现"><a class="anchor" href="#niagara实现">#</a> <strong>Niagara 实现</strong></h1><p>从上面可以知道 MLS-MPM 是实现起来非常简单，运行性能也很快，所以在 Niagara 实现也很简洁</p><p>首先是设置 Grid3d，这里要用到原子操作，所以要用到 Rasterization Grid3D，这里有很奇怪的 bug，在跑 Rasterization Grid3D 一定要带 Grid3D 一起玩，否则粒子动一下就不动了。</p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-22686bbc34c85b103d92c57ed1a8a53f_1440w.png" alt="v2-22686bbc34c85b103d92c57ed1a8a53f_1440w.png"></p><p>因为要把速度和质量写入 grid3d，所以 RasGrid 的 NumAttribute 要开 4 个，我写 7 个是因为还要把颜色写入可以做不同发射源做颜色混合。</p><h1 id="initial"><a class="anchor" href="#initial">#</a> <strong>initial</strong></h1><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-0945fa51c723f78144ce20bc43582a6d_1440w.png" alt="v2-0945fa51c723f78144ce20bc43582a6d_1440w.png"></p><h2 id="p2g"><a class="anchor" href="#p2g">#</a> <strong>P2G</strong></h2><p>然后做 P2G 操作，这里我写了个很傻的模组，就是把粒子 trasform 到 Grid 空间，就是把位置和速度归化 0-1，因为我们是显示积分，要是用世界位置的话，一下子数字就 inf 就炸开了，在官方有个 module 可以直接用来算矩阵然后 mul position 就行了</p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-c8ef84a9f1d21e1bd9ba02d56f32e013_1440w.png" alt="v2-c8ef84a9f1d21e1bd9ba02d56f32e013_1440w.png"></p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-97dddfc76a2d55d66244e0e93ce997e4_1440w.png" alt="v2-97dddfc76a2d55d66244e0e93ce997e4_1440w.png"></p><p>在流体模拟里面，形变矩阵 F 会随着时间变得越来越大，但模拟到一定时候后，float 这时候精度就不够用了，为了解决问题，在<span class="exturl" data-url="aHR0cHM6Ly9kbC5hY20ub3JnL2RvaS9hYnMvMTAuMTE0NS8zMDcyOTU5LjMwNzM2NTE="> A.P Tampubolon et al. (2017)</span> 这篇文章中我们可以用 F 的行列式来表示整个矩阵的变化，这时候我们就可以用去记录 F，用 J 来代替，J 的定义如下。其中矩阵 C 对体积有贡献的只有对角线，所以就用 C 的迹</p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-bd21270d3d3e3e27f65946c562093af9_1440w.png" alt="v2-bd21270d3d3e3e27f65946c562093af9_1440w.png"></p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">int</span> Cellx;<br><span class="hljs-built_in">int</span> Celly;<br><span class="hljs-built_in">int</span> Cellz;<br>RasterizationGrid3D.GetNumCells(Cellx, Celly, Cellz);<br><span class="hljs-built_in">float</span> dx = <span class="hljs-number">1</span>/(<span class="hljs-built_in">float</span>)Cellx;<br>float3 CellPosition = Position * Cellx;<br>float3 BasePosition = floor(CellPosition - <span class="hljs-number">0.5</span>);<br>float3 FPosition = CellPosition - BasePosition;<br>TestVector = FPosition;<br>float3 Weight[<span class="hljs-number">3</span>];<br><span class="hljs-built_in">float</span> IGNORE ;<br>Weight[<span class="hljs-number">0</span>] = <span class="hljs-number">0.5</span> * (<span class="hljs-number">1.5</span> - FPosition) * (<span class="hljs-number">1.5</span> - FPosition);<br>Weight[<span class="hljs-number">1</span>] = <span class="hljs-number">0.75</span> - (FPosition - <span class="hljs-number">1</span>) * (FPosition - <span class="hljs-number">1</span>);<br>Weight[<span class="hljs-number">2</span>] = <span class="hljs-number">0.5</span> * (FPosition - <span class="hljs-number">0.5</span>) * (FPosition - <span class="hljs-number">0.5</span>);<br><span class="hljs-built_in">float</span> DeltaDx = dx*dx;<br><span class="hljs-built_in">float</span> pvol = <span class="hljs-built_in">pow</span>(dx*<span class="hljs-number">0.5</span> ,<span class="hljs-number">3</span>);<br>J = J * (<span class="hljs-number">1</span> + DeltaTime * (C[<span class="hljs-number">0</span>][<span class="hljs-number">0</span>] + C[<span class="hljs-number">1</span>][<span class="hljs-number">1</span>] + C[<span class="hljs-number">2</span>][<span class="hljs-number">2</span>]));<br>OutJ = J;<br><span class="hljs-built_in">float</span> Stress = -DeltaTime * <span class="hljs-number">4.0</span> * E * pvol * (J - <span class="hljs-number">1</span>) / DeltaDx;<br>float4x4 Affine = &#123;<br>Stress,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,Stress,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,<span class="hljs-number">0</span>,Stress,<span class="hljs-number">0</span>,<br><span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span><br>&#125;;<br>Affine += Mass * C;<br><span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>;x&lt;<span class="hljs-number">3</span>;x++)<br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">3</span>; y++)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> z = <span class="hljs-number">0</span>; z&lt;<span class="hljs-number">3</span>; z++)<br>        &#123;<br>            float3 offset = float3(x,y,z);<br>            float3 Dpos = (offset - FPosition) * dx;<br>            <span class="hljs-built_in">int</span> IndexX = BasePosition.x + offset.x;<br>            <span class="hljs-built_in">int</span> IndexY = BasePosition.y + offset.y;<br>            <span class="hljs-built_in">int</span> IndexZ = BasePosition.z + offset.z;<br>            <span class="hljs-keyword">if</span>(IndexX &lt; Cellx&amp;&amp;IndexY &lt; Celly&amp;&amp;IndexZ &lt; Cellz&amp;&amp;<br>                IndexX &gt; <span class="hljs-number">0</span>&amp;&amp;IndexY &gt; <span class="hljs-number">0</span>&amp;&amp;IndexZ &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-built_in">float</span> CellWeight = Weight[x].x*Weight[y].y*Weight[z].z;<br>                float4 GridData = <span class="hljs-number">0</span>;<br>               <br>                float3 GridVelocity ;//= GridData.xyz ;<br>                float4 Mpos = float4(Dpos,<span class="hljs-number">0</span>);<br>                GridVelocity = CellWeight*(Mass * Velocity + mul(Mpos,Affine));<br>               <br>                <span class="hljs-built_in">float</span> GridMass ;//= GridData.w;<br>                GridMass =  CellWeight * Mass;<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">0</span>, GridVelocity.x,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">1</span>, GridVelocity.y,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">2</span>, GridVelocity.z,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">3</span>, GridMass,IGNORE);<br>                <br><br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">4</span>,Color.x *CellWeight ,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">5</span>, Color.y *CellWeight,IGNORE);<br>                RasterizationGrid3D.InterlockedAddFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">6</span>, Color.z *CellWeight,IGNORE);<br>                //Grid3D.SetVector4ValueAtIndex(IndexX, IndexY, IndexZ, <span class="hljs-number">0</span>, float4(GridVelocity,GridMass));<br><br>            &#125;<br>            <br><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><p></p><h1 id="g2p"><a class="anchor" href="#g2p">#</a> <strong>G2P</strong></h1><p>因为我没有做什么其他物质之间的交互，所以我们省略中间对 Grid 的操作，还有一点就是我不知道为什么单独操作 Rasterization Grid3D, 值是 0，所以我放弃这一个，直接合到 G2P 过程，并且在这里做 Bound 操作</p><p><img data-src="MPM%E6%B0%B4%207e3c13232e9c453fa5a978b0a16e9e78/v2-496faff3e90cfa377765ed7d354768ff_1440w.png" alt="v2-496faff3e90cfa377765ed7d354768ff_1440w.png"></p><p></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">int</span> Cellx;<br><span class="hljs-built_in">int</span> Celly;<br><span class="hljs-built_in">int</span> Cellz;<br>RasterizationGrid3D.GetNumCells(Cellx, Celly, Cellz);<br><span class="hljs-built_in">float</span> dx = <span class="hljs-number">1</span>/(<span class="hljs-built_in">float</span>)Cellx; //(<span class="hljs-built_in">float</span>)Cellx / WorldSize.x;<br>float3 CellPosition =Position*Cellx;<br>float3 BasePosition = floor(CellPosition - <span class="hljs-number">0.5</span>);<br>float3 FPosition = CellPosition - BasePosition;<br>float3 Weight[<span class="hljs-number">3</span>];<br><br>Weight[<span class="hljs-number">0</span>] = <span class="hljs-number">0.5</span> * (<span class="hljs-number">1.5</span> - FPosition) * (<span class="hljs-number">1.5</span> - FPosition);<br>Weight[<span class="hljs-number">1</span>] = <span class="hljs-number">0.75</span> - (FPosition - <span class="hljs-number">1</span>) * (FPosition - <span class="hljs-number">1</span>);<br>Weight[<span class="hljs-number">2</span>] = <span class="hljs-number">0.5</span> * (FPosition - <span class="hljs-number">0.5</span>) * (FPosition - <span class="hljs-number">0.5</span>);<br><span class="hljs-built_in">float</span> DeltaDx = dx * dx;<br>NewV = <span class="hljs-number">0</span>;<br>float4x4 C = <span class="hljs-number">0</span>;<br>Test = dx;<br>OutColor = <span class="hljs-number">0</span>;<br><span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> x = <span class="hljs-number">0</span>;x&lt;<span class="hljs-number">3</span>;x++)<br>&#123;<br>    <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> y = <span class="hljs-number">0</span>; y &lt; <span class="hljs-number">3</span>; y++)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> z = <span class="hljs-number">0</span>; z&lt;<span class="hljs-number">3</span>; z++)<br>        &#123;<br>            float3 offset = float3(x,y,z);<br>            float3 Dpos = (offset - FPosition) * dx;<br>            <br>            <span class="hljs-built_in">int</span> IndexX = BasePosition.x + offset.x;<br>            <span class="hljs-built_in">int</span> IndexY = BasePosition.y + offset.y;<br>            <span class="hljs-built_in">int</span> IndexZ = BasePosition.z + offset.z;<br>            <span class="hljs-keyword">if</span>(IndexX &lt; Cellx&amp;&amp;IndexY &lt; Celly&amp;&amp;IndexZ &lt; Cellz&amp;&amp;<br>                IndexX &gt; <span class="hljs-number">0</span>&amp;&amp;IndexY &gt; <span class="hljs-number">0</span>&amp;&amp;IndexZ &gt; <span class="hljs-number">0</span>)<br>            &#123;<br>                <span class="hljs-built_in">float</span> CellWeight = Weight[x].x*Weight[y].y*Weight[z].z;<br>                float4 GridData;<br>                <br>                //Grid3DCollection.GetPreviousVector4ValueAtIndex(IndexX, IndexY, IndexZ, <span class="hljs-number">0</span>, GridData);<br>                RasterizationGrid3D.GetFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">0</span>, GridData.x);<br>                RasterizationGrid3D.GetFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">1</span>, GridData.y);<br>                RasterizationGrid3D.GetFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">2</span>, GridData.z);<br>                RasterizationGrid3D.GetFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">3</span>, GridData.w);<br>                float3 TempColor = <span class="hljs-number">0</span>;<br>                RasterizationGrid3D.GetFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">4</span>, TempColor.x);<br>                RasterizationGrid3D.GetFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">5</span>, TempColor.y);<br>                RasterizationGrid3D.GetFloatGridValue(IndexX, IndexY, IndexZ, <span class="hljs-number">6</span>, TempColor.z);<br>                OutColor +=TempColor.xyz * CellWeight*BlendColor;<br><br>				<span class="hljs-keyword">if</span>(GridData.w &gt; <span class="hljs-number">0</span>)<br>				&#123;<br>				    GridData.xyz /= GridData.w;<br>				&#125;<br>				GridData.xyz -= DeltaTime * G;<br>				 <span class="hljs-built_in">float</span> DistanceToNearestSurface;<br>				float3 FieldGradient;<br>				 <span class="hljs-built_in">bool</span> IsDistanceFieldValid;<br>				CollisionQuery.QueryMeshDistanceFieldGPU(float3(IndexX,IndexY,IndexZ)*(WorldSize/Cellx),  DistanceToNearestSurface,  FieldGradient, IsDistanceFieldValid);<br><br>				<span class="hljs-keyword">if</span>(IndexX &gt; Cellx - Bound &amp;&amp; GridData.x &gt; <span class="hljs-number">0</span>)<br>				&#123;<br>				    GridData.x *=-Elasticity;<br>				&#125;<br>				<span class="hljs-keyword">if</span>(IndexX &lt; Bound &amp;&amp; GridData.x &lt; <span class="hljs-number">0</span>)<br>				&#123;<br>				    GridData.x *=-Elasticity;<br>				&#125;<br>				<span class="hljs-keyword">if</span>(IndexY &gt; Celly - Bound &amp;&amp; GridData.y &gt; <span class="hljs-number">0</span>)<br>				&#123;<br>				    GridData.y *=-Elasticity;<br>				&#125;<br>				<span class="hljs-keyword">if</span>(IndexY &lt;  Bound &amp;&amp; GridData.y &lt; <span class="hljs-number">0</span>)<br>				&#123;<br>				    GridData.y *=-Elasticity;<br>				&#125;<br>				<span class="hljs-keyword">if</span>(IndexZ &gt; Cellz - Bound &amp;&amp; GridData.z &gt; <span class="hljs-number">0</span>)<br>				&#123;<br>				    GridData.z *=<span class="hljs-number">0</span>;<br>				&#125;<br>				<span class="hljs-keyword">if</span>(IndexZ &lt;  Bound &amp;&amp; GridData.z &lt; <span class="hljs-number">0</span>)<br>				&#123;<br>				    GridData.z*=<span class="hljs-number">0</span>;<br>				&#125;<br>				<span class="hljs-keyword">if</span>(IsDistanceFieldValid&amp;&amp;DistanceToNearestSurface &lt;<span class="hljs-number">3</span>)<br>				&#123;<br>				    //float3 CollisionVelocity =(normalize( GridData.xyz )+normalize(FieldGradient))*length(GridData.xyz)*<span class="hljs-number">0.9</span> ;<br>				    GridData.xyz =lerp(normalize( GridData.xyz ),normalize(FieldGradient),<span class="hljs-number">1</span>)*length(GridData.xyz)*<span class="hljs-number">1.5</span>;<br>				&#125;<br>                float3 GridVelocity = GridData.xyz  ;<br>                NewV += CellWeight * GridVelocity;<br>                //Dpos = normalize(Dpos);<br>                float4x4 GOuterProduct = &#123;<br>                GridVelocity.x * Dpos.x, GridVelocity.x * Dpos.y, GridVelocity.x * Dpos.z,<span class="hljs-number">0</span>,<br>                GridVelocity.y * Dpos.x, GridVelocity.y * Dpos.y, GridVelocity.y * Dpos.z,<span class="hljs-number">0</span>,<br>                GridVelocity.z * Dpos.x, GridVelocity.z * Dpos.y, GridVelocity.z * Dpos.z,<span class="hljs-number">0</span>,<br>                <span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span><br>                &#125;;                //NewC=  GOuterProduct ;<br>                C += <span class="hljs-number">4</span> * CellWeight * GOuterProduct / DeltaDx;<br>            &#125;<br>            <br>        &#125;<br>    &#125;<br>&#125;<br>OutColor = saturate(lerp(Color,OutColor,<span class="hljs-number">0.01</span>));<br><span class="hljs-built_in">float</span> colF1 = length(C[<span class="hljs-number">0</span>]);<br><span class="hljs-built_in">float</span> colF2 = length(C[<span class="hljs-number">1</span>]);<br><span class="hljs-built_in">float</span> colF3 = length(C[<span class="hljs-number">2</span>]);<br><span class="hljs-built_in">float</span> Fa = length(float3(colF1,colF2,colF3));<br><span class="hljs-keyword">if</span>(Fa &gt;<span class="hljs-number">50</span>)<br>&#123;<br>   C /=<span class="hljs-number">2.</span>f;<br>   /*<span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> i = <span class="hljs-number">0</span>;i&lt;<span class="hljs-number">4</span>;i++)<br>    &#123;<br>        <span class="hljs-keyword">for</span>(<span class="hljs-built_in">int</span> j = <span class="hljs-number">0</span> ;j &lt; <span class="hljs-number">4</span>; j++)<br>        &#123;<br>            C[i][j] = clamp(C[i][j],-<span class="hljs-number">10</span>,<span class="hljs-number">10</span>);<br>        &#125;<br>    &#125;*/<br>&#125;<br>//NewV.z -= <span class="hljs-number">98.</span>f;<br>NewC = C ;<br></code></pre></td></tr></table></figure><p></p><div class="tags"><a href="/tags/%E6%A8%A1%E6%8B%9F/" rel="tag"><i class="ic i-tag"></i> 模拟</a> <a href="/tags/%E6%96%87%E7%AB%A0/" rel="tag"><i class="ic i-tag"></i> 文章</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2023-12-30 13:58:27" itemprop="dateModified" datetime="2023-12-30T13:58:27+08:00">2023-12-30</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Natsuneko 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Natsuneko 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Natsuneko 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Natsuneko <i class="ic i-at"><em>@</em></i>夏猫</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2023/12/24/simulation/MPMWater/" title="MPM 水">http://example.com/2023/12/24/simulation/MPMWater/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2023/10/16/simulation/%E7%9F%A9%E9%98%B5/SingularValueDecomposition/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3&#x2F;wallpaperLibrary&#x2F;raw&#x2F;main&#x2F;wallhaven-3l96wy.jpg" title="奇异值分解"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> 模拟笔记</span><h3>奇异值分解</h3></a></div><div class="item right"><a href="/2023/12/24/simulation/MPMSnow/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3&#x2F;wallpaperLibrary&#x2F;raw&#x2F;main&#x2F;wallhaven-dpwgqo.png" title="MPM雪、海绵"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 文章</span><h3>MPM雪、海绵</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#mpm%E6%B0%B4"><span class="toc-number">1.</span> <span class="toc-text">MPM 水</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">1.1.</span> <span class="toc-text">简介</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mpm"><span class="toc-number">2.</span> <span class="toc-text">MPM</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pic-particle-in-cell"><span class="toc-number">2.1.</span> <span class="toc-text">PIC - Particle In Cell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#apic-affine-particle-in-cell"><span class="toc-number">2.2.</span> <span class="toc-text">APIC-affine particle in cell</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mls-mpm"><span class="toc-number">2.3.</span> <span class="toc-text">MLS-MPM</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mls-mpm%E5%85%AC%E5%BC%8F%E6%8E%A8%E5%AF%BC"><span class="toc-number">2.4.</span> <span class="toc-text">MLS-MPM 公式推导</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#niagara%E5%AE%9E%E7%8E%B0"><span class="toc-number">3.</span> <span class="toc-text">Niagara 实现</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#initial"><span class="toc-number">4.</span> <span class="toc-text">initial</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#p2g"><span class="toc-number">4.1.</span> <span class="toc-text">P2G</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#g2p"><span class="toc-number">5.</span> <span class="toc-text">G2P</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2021/09/29/color/" rel="bookmark" title="【VFX】浅析特效设计与色彩（1）">【VFX】浅析特效设计与色彩（1）</a></li><li><a href="/2021/10/07/color2/" rel="bookmark" title="【VFX】浅析特效设计与色彩（2）">【VFX】浅析特效设计与色彩（2）</a></li><li><a href="/2022/02/12/Niagara/" rel="bookmark" title="【UE4】新手特效向Niagara常见问题解决与小技巧分享（不定期更新）">【UE4】新手特效向Niagara常见问题解决与小技巧分享（不定期更新）</a></li><li><a href="/2022/04/08/Softbody/" rel="bookmark" title="【UE5】在niagara实现Softbody dynamic">【UE5】在niagara实现Softbody dynamic</a></li><li><a href="/2022/06/26/MultiPass/" rel="bookmark" title="【虚幻引擎】在UE实现多Pass Renderer">【虚幻引擎】在UE实现多Pass Renderer</a></li><li><a href="/2022/11/07/DualKawaseBlur/" rel="bookmark" title="【UE4/UE5】拓展后期pass实现DualKawaseBlur">【UE4/UE5】拓展后期pass实现DualKawaseBlur</a></li><li><a href="/2022/11/29/oit/" rel="bookmark" title="【UE5】浅析UE5.1OIT半透明排序算法">【UE5】浅析UE5.1OIT半透明排序算法</a></li><li><a href="/2023/02/17/simulation/%E5%9F%BA%E4%BA%8ELBM(Lattice%20Boltzmann%20Method)%E6%B5%81%E4%BD%93%E6%A8%A1%E6%8B%9F/" rel="bookmark" title="基于LBM(Lattice Boltzmann Method)流体模拟">基于LBM(Lattice Boltzmann Method)流体模拟</a></li><li><a href="/2023/12/24/simulation/MPMSnow/" rel="bookmark" title="MPM雪、海绵">MPM雪、海绵</a></li><li class="active"><a href="/2023/12/24/simulation/MPMWater/" rel="bookmark" title="MPM水">MPM水</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Natsuneko" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Natsuneko</p><div class="description" itemprop="description">主要分享关于 ue 或者 TA 的知识，也或者分享点自己想写的东西，作品什么的</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">66</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">17</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL05hdHN1bmVrbzM=" title="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9uYXRzdW5la29zYW4=" title="https:&#x2F;&#x2F;twitter.com&#x2F;natsunekosan"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9OYXRzdW5la28=" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;Natsuneko"><i class="ic i-zhihu"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cucmVhbHRpbWUueHl6Lw=="><i class="ic i-heart"></i>friends</span></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2023/10/16/simulation/%E7%9F%A9%E9%98%B5/SingularValueDecomposition/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2023/12/24/simulation/MPMSnow/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Natsuneko @ Natsu neko</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">339k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:08</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2023/12/24/simulation/MPMWater/",favicon:{show:"（●´3｀●）感觉还不错把",hide:"____________________________________"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,copy_tex:!0,katex:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(_){return _.includes("#")},function(_){return new RegExp(LOCAL.path+"$").test(_)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>