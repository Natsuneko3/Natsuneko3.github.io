<hr />
<h2 id="title-sh求谐函数与立体角date-2022-04-07-1200count-truetags-图形学笔记category-图形学笔记"><a class="anchor" href="#title-sh求谐函数与立体角date-2022-04-07-1200count-truetags-图形学笔记category-图形学笔记">#</a> title: SH 求谐函数与立体角<br />
 date: 2022-04-07 12:00<br />
count: true<br />
tags: 图形学笔记<br />
 category: 图形学笔记</h2>
<h1 id="sh求谐函数与立体角"><a class="anchor" href="#sh求谐函数与立体角">#</a> SH 求谐函数与立体角</h1>
<p><img src="Untitled.png" alt="Untitled" /></p>
<h1 id="直角坐标系转球面坐标系"><a class="anchor" href="#直角坐标系转球面坐标系">#</a> 直角坐标系转球面坐标系</h1>
<p><img src="Untitled%201.png" alt="Untitled" /></p>
<p>球坐标转 uv</p>
<p><img src="Untitled%202.png" alt="Untitled" /></p>
<p><img src="Untitled%203.png" alt="Untitled" /></p>
<figure class="highlight glsl"><figcaption data-lang="GLSL"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token comment">//uv 转 vector</span></pre></td></tr><tr><td data-num="2"></td><td><pre>float4 <span class="token function">UniformSampleSphere</span><span class="token punctuation">(</span> float2 E <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">float</span> Phi <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> PI <span class="token operator">*</span> E<span class="token punctuation">.</span>x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">float</span> CosTheta <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">-</span> <span class="token number">2</span> <span class="token operator">*</span> E<span class="token punctuation">.</span>y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>	<span class="token keyword">float</span> SinTheta <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span> <span class="token number">1</span> <span class="token operator">-</span> CosTheta <span class="token operator">*</span> CosTheta <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre>	float3 H<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>	H<span class="token punctuation">.</span>x <span class="token operator">=</span> SinTheta <span class="token operator">*</span> <span class="token function">cos</span><span class="token punctuation">(</span> Phi <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	H<span class="token punctuation">.</span>y <span class="token operator">=</span> SinTheta <span class="token operator">*</span> <span class="token function">sin</span><span class="token punctuation">(</span> Phi <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	H<span class="token punctuation">.</span>z <span class="token operator">=</span> CosTheta<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">float</span> PDF <span class="token operator">=</span> <span class="token number">1.0</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span> <span class="token operator">*</span> PI<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">return</span> <span class="token function">float4</span><span class="token punctuation">(</span> H<span class="token punctuation">,</span> PDF <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>SH 求谐函数</p>
<p>UE 用的 2 阶</p>
<p>ue 存这 27 个 SH</p>
<figure class="highlight glsl"><figcaption data-lang="GLSL"></figcaption><table><tr><td data-num="1"></td><td><pre>FThreeBandSHVector <span class="token function">SHBasisFunction3</span><span class="token punctuation">(</span>half3 InputVector<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>FThreeBandSHVectorResult<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token comment">// These are derived from simplifying SHBasisFunction in C++</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   Result<span class="token punctuation">.</span>V0<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">0.282095f</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>   Result<span class="token punctuation">.</span>V0<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.488603f</span> <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>   Result<span class="token punctuation">.</span>V0<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0.488603f</span> <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>z<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   Result<span class="token punctuation">.</span>V0<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">0.488603f</span> <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>   half3 VectorSquared <span class="token operator">=</span> InputVector <span class="token operator">*</span> InputVector<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>   Result<span class="token punctuation">.</span>V1<span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token number">1.092548f</span> <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>x <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>y<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>   Result<span class="token punctuation">.</span>V1<span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.092548f</span> <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>y <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>z<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>   Result<span class="token punctuation">.</span>V1<span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">0.315392f</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">3.0f</span> <span class="token operator">*</span> VectorSquared<span class="token punctuation">.</span>z <span class="token operator">-</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   Result<span class="token punctuation">.</span>V1<span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1.092548f</span> <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>x <span class="token operator">*</span> InputVector<span class="token punctuation">.</span>z<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   Result<span class="token punctuation">.</span>V2 <span class="token operator">=</span> <span class="token number">0.546274f</span> <span class="token operator">*</span> <span class="token punctuation">(</span>VectorSquared<span class="token punctuation">.</span>x <span class="token operator">-</span> VectorSquared<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token keyword">return</span> Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="19"></td><td><pre></pre></td></tr><tr><td data-num="20"></td><td><pre>FThreeBandSHVectorRGB <span class="token function">SampleSHRGB</span><span class="token punctuation">(</span><span class="token keyword">in</span> float3 SampleDirection<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> weight<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> MipLevel<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>	<span class="token keyword">const</span> float3 SampleColor <span class="token operator">=</span> SourceCubemapTexture<span class="token punctuation">.</span><span class="token function">SampleLevel</span><span class="token punctuation">(</span>SourceCubemapSampler<span class="token punctuation">,</span> SampleDirection<span class="token punctuation">,</span> MipLevel<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre></pre></td></tr><tr><td data-num="24"></td><td><pre>	FThreeBandSHVector Sh3Vector <span class="token operator">=</span> <span class="token function">SHBasisFunction3</span><span class="token punctuation">(</span>SampleDirection<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>	FThreeBandSHVectorRGB Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>	Result<span class="token punctuation">.</span>R <span class="token operator">=</span> <span class="token function">MulSH3</span><span class="token punctuation">(</span>Sh3Vector<span class="token punctuation">,</span> SampleColor<span class="token punctuation">.</span>r <span class="token operator">*</span> weight<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//weight 是 4Π/ 采样次数</span></pre></td></tr><tr><td data-num="27"></td><td><pre>	Result<span class="token punctuation">.</span>G <span class="token operator">=</span> <span class="token function">MulSH3</span><span class="token punctuation">(</span>Sh3Vector<span class="token punctuation">,</span> SampleColor<span class="token punctuation">.</span>g <span class="token operator">*</span> weight<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre>	Result<span class="token punctuation">.</span>B <span class="token operator">=</span> <span class="token function">MulSH3</span><span class="token punctuation">(</span>Sh3Vector<span class="token punctuation">,</span> SampleColor<span class="token punctuation">.</span>b <span class="token operator">*</span> weight<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>	<span class="token keyword">return</span> Result<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="31"></td><td><pre></pre></td></tr><tr><td data-num="32"></td><td><pre><span class="token keyword">void</span> <span class="token function">ComputeSkyEnvMapDiffuseIrradianceCS</span><span class="token punctuation">(</span>uint3 ThreadId <span class="token operator">:</span> SV_DispatchThreadID<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="33"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">uint</span> LinearIndex <span class="token operator">=</span> THREADGROUP_SIZE_X <span class="token operator">*</span> ThreadId<span class="token punctuation">.</span>y <span class="token operator">+</span> ThreadId<span class="token punctuation">.</span>x<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre></pre></td></tr><tr><td data-num="36"></td><td><pre>	<span class="token comment">// For a 128x128 cubemap, sampling mip level 2 with only 8x8 samples matches closely the super sampled version.</span></pre></td></tr><tr><td data-num="37"></td><td><pre>	<span class="token keyword">const</span> float3 SampleDirection <span class="token operator">=</span> <span class="token function">UniformSampleSphere</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token function">float2</span><span class="token punctuation">(</span>ThreadId<span class="token punctuation">.</span>xy<span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">0.5f</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token function">float2</span><span class="token punctuation">(</span>THREADGROUP_SIZE_X<span class="token punctuation">,</span> THREADGROUP_SIZE_Y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>	IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">SampleSHRGB</span><span class="token punctuation">(</span>SampleDirection<span class="token punctuation">,</span> UniformSampleSolidAngle<span class="token punctuation">,</span> MipIndex<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">THREADGROUP_SIZE <span class="token operator">!=</span> <span class="token number">64</span></span></span></pre></td></tr><tr><td data-num="41"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">error</span> <span class="token expression">That is the only reduction supported today</span></span></pre></td></tr><tr><td data-num="42"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="43"></td><td><pre></pre></td></tr><tr><td data-num="44"></td><td><pre>	<span class="token comment">// Wait for all group threads to be done</span></pre></td></tr><tr><td data-num="45"></td><td><pre>	<span class="token function">GroupMemoryBarrierWithGroupSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre></pre></td></tr><tr><td data-num="47"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>LinearIndex <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="48"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="49"></td><td><pre>		IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">AddSH</span><span class="token punctuation">(</span>IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> IrradianceSHShared<span class="token punctuation">[</span>LinearIndex <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>	<span class="token function">GroupMemoryBarrierWithGroupSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="52"></td><td><pre></pre></td></tr><tr><td data-num="53"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>LinearIndex <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="54"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>		IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">AddSH</span><span class="token punctuation">(</span>IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> IrradianceSHShared<span class="token punctuation">[</span>LinearIndex <span class="token operator">+</span> <span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre>	<span class="token function">GroupMemoryBarrierWithGroupSync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="58"></td><td><pre></pre></td></tr><tr><td data-num="59"></td><td><pre>	<span class="token comment">// The smallest wave size is 16 on Intel hardware. So now we can do simple math operations without group sync.</span></pre></td></tr><tr><td data-num="60"></td><td><pre></pre></td></tr><tr><td data-num="61"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>LinearIndex <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="62"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>		IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">AddSH</span><span class="token punctuation">(</span>IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> IrradianceSHShared<span class="token punctuation">[</span>LinearIndex <span class="token operator">+</span> <span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>LinearIndex <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="66"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="67"></td><td><pre>		IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">AddSH</span><span class="token punctuation">(</span>IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> IrradianceSHShared<span class="token punctuation">[</span>LinearIndex <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="68"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="69"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>LinearIndex <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="70"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="71"></td><td><pre>		IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">AddSH</span><span class="token punctuation">(</span>IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> IrradianceSHShared<span class="token punctuation">[</span>LinearIndex <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="72"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="73"></td><td><pre></pre></td></tr><tr><td data-num="74"></td><td><pre>	<span class="token keyword">if</span> <span class="token punctuation">(</span>LinearIndex <span class="token operator">&lt;</span> <span class="token number">1</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="75"></td><td><pre>	<span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>		FThreeBandSHVectorRGB SkyIrradiance <span class="token operator">=</span> <span class="token function">AddSH</span><span class="token punctuation">(</span>IrradianceSHShared<span class="token punctuation">[</span>LinearIndex<span class="token punctuation">]</span><span class="token punctuation">,</span> IrradianceSHShared<span class="token punctuation">[</span>LinearIndex <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre></pre></td></tr><tr><td data-num="78"></td><td><pre>		<span class="token comment">// Pack the SH coefficients in a way that makes applying the lighting use the least shader instructions</span></pre></td></tr><tr><td data-num="79"></td><td><pre>		<span class="token comment">// This has the diffuse convolution coefficients baked in. See "Stupid Spherical Harmonics (SH) Tricks".</span></pre></td></tr><tr><td data-num="80"></td><td><pre>		<span class="token comment">//https://wolfand11.gitee.io/blogs/graphics/StupidSphericalHarmonics.html</span></pre></td></tr><tr><td data-num="81"></td><td><pre>		<span class="token comment">// Also see UpdateSkyIrradianceGpuBuffer.</span></pre></td></tr><tr><td data-num="82"></td><td><pre>		<span class="token keyword">const</span> <span class="token keyword">float</span> SqrtPI <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>PI<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="83"></td><td><pre>		<span class="token keyword">const</span> <span class="token keyword">float</span> Coefficient0 <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">2.0f</span> <span class="token operator">*</span> SqrtPI<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>		<span class="token keyword">const</span> <span class="token keyword">float</span> Coefficient1 <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">3.0f</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">3.0f</span> <span class="token operator">*</span> SqrtPI<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>		<span class="token keyword">const</span> <span class="token keyword">float</span> Coefficient2 <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">15.0f</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">8.0f</span> <span class="token operator">*</span> SqrtPI<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>		<span class="token keyword">const</span> <span class="token keyword">float</span> Coefficient3 <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token number">5.0f</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">16.0f</span> <span class="token operator">*</span> SqrtPI<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>		<span class="token keyword">const</span> <span class="token keyword">float</span> Coefficient4 <span class="token operator">=</span> <span class="token number">0.5f</span> <span class="token operator">*</span> Coefficient2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="88"></td><td><pre></pre></td></tr><tr><td data-num="89"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token operator">-</span>Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span>Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="91"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span>  Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>w <span class="token operator">=</span>  Coefficient0 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> Coefficient3 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[6];</span></pre></td></tr><tr><td data-num="93"></td><td><pre></pre></td></tr><tr><td data-num="94"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token operator">-</span>Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span>Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="96"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span>  Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="97"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>w <span class="token operator">=</span>  Coefficient0 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> Coefficient3 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[6];</span></pre></td></tr><tr><td data-num="98"></td><td><pre></pre></td></tr><tr><td data-num="99"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> <span class="token operator">-</span>Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span>Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span>  Coefficient1 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span>w <span class="token operator">=</span>  Coefficient0 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V0<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">-</span> Coefficient3 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[6];</span></pre></td></tr><tr><td data-num="103"></td><td><pre></pre></td></tr><tr><td data-num="104"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span>  Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[4];</span></pre></td></tr><tr><td data-num="105"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span>Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//V[5];</span></pre></td></tr><tr><td data-num="106"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">3.0f</span> <span class="token operator">*</span> Coefficient3 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[6];</span></pre></td></tr><tr><td data-num="107"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token operator">-</span>Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[7];</span></pre></td></tr><tr><td data-num="108"></td><td><pre></pre></td></tr><tr><td data-num="109"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span>  Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[4];</span></pre></td></tr><tr><td data-num="110"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span>Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[5];</span></pre></td></tr><tr><td data-num="111"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">3.0f</span> <span class="token operator">*</span> Coefficient3 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[6];</span></pre></td></tr><tr><td data-num="112"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token operator">-</span>Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[7];</span></pre></td></tr><tr><td data-num="113"></td><td><pre></pre></td></tr><tr><td data-num="114"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span>  Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[4];</span></pre></td></tr><tr><td data-num="115"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> <span class="token operator">-</span>Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[5];</span></pre></td></tr><tr><td data-num="116"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span> <span class="token number">3.0f</span> <span class="token operator">*</span> Coefficient3 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[6];</span></pre></td></tr><tr><td data-num="117"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span><span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token operator">-</span>Coefficient2 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">//[7];</span></pre></td></tr><tr><td data-num="118"></td><td><pre></pre></td></tr><tr><td data-num="119"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>x <span class="token operator">=</span> Coefficient4 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>R<span class="token punctuation">.</span>V2<span class="token punctuation">;</span><span class="token comment">//[8];</span></pre></td></tr><tr><td data-num="120"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>y <span class="token operator">=</span> Coefficient4 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>G<span class="token punctuation">.</span>V2<span class="token punctuation">;</span><span class="token comment">//[8];</span></pre></td></tr><tr><td data-num="121"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>z <span class="token operator">=</span> Coefficient4 <span class="token operator">*</span> SkyIrradiance<span class="token punctuation">.</span>B<span class="token punctuation">.</span>V2<span class="token punctuation">;</span><span class="token comment">//[8];</span></pre></td></tr><tr><td data-num="122"></td><td><pre>		OutIrradianceEnvMapSH<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">.</span>w <span class="token operator">=</span> <span class="token number">1.0f</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="123"></td><td><pre>	<span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure>