<hr />
<p>title: Volume Rendering<br />
date: 2023-09-23 12:00<br />
tags:</p>
<ul>
<li>笔记</li>
<li>图形学笔记<br />
 category: 图形学笔记<br />
 count: true</li>
</ul>
<hr />
<h1 id="volume-rendering"><a class="anchor" href="#volume-rendering">#</a> Volume Rendering</h1>
<p><img src="Untitled.png" alt="Untitled" /></p>
<p>在光传播时，抽象点来说就是分子把收集到的光带到你的眼睛里，但这过程中会发生各种情况扰乱光的传播。</p>
<ul>
<li>通过介质传播到眼睛的光束会由于以下原因损失能量
<ul>
<li>吸收（Absorption）吸收了一部份的光，把收集到的光吸收了一部份</li>
<li>外散射（Out-scattering）把一部份光散射出去给别的分子，从而光能力不能到你的眼睛</li>
</ul>
</li>
<li>通过介质传播到眼睛的光束会由于以下原因损失能量
<ul>
<li>自发光（Emissive）就是自己的光能量</li>
<li>内散射（In- Scattering）把从四面八方发射出来的光收集起来带到我们的眼睛，可以理解为 Irradiance</li>
</ul>
</li>
</ul>
<p><img src="Untitled%201.png" alt="Untitled" /></p>
<p>渲染时候用 Raymrach 做法，摄像机每步想前前进然后再想太阳方向累加求积分，在 ue volume cloud 中主要做了 2 次，算 <code>LuminanceIntegral</code>  时候</p>
<h1 id="scattering"><a class="anchor" href="#scattering">#</a> <strong>Scattering</strong></h1>
<figure class="highlight jsx"><figcaption data-lang="React JSX"><span>""</span></figcaption><table><tr><td data-num="1"></td><td><pre>float3 LuminanceIntegral <span class="token operator">=</span> <span class="token punctuation">(</span>ScatteredLuminance <span class="token operator">-</span> ScatteredLuminance <span class="token operator">*</span> SafePathSegmentTransmittance<span class="token punctuation">)</span> <span class="token operator">/</span> SafeExtinctionCoefficients<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token comment">// 等价，在 ue 水体渲染就用了这公式</span></pre></td></tr><tr><td data-num="3"></td><td><pre> float3 ScatteringAmount <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span>ScatteringCoeff <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span>0f <span class="token operator">-</span> Transmittance<span class="token punctuation">)</span> <span class="token operator">/</span> ExtinctionCoeffSafe<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><p>算 Transmittance，其中 extension = <strong>Absorption + Scattering ,</strong> S 就是距离或者深度，这个 extension 可以自定义，也就是说这三个数都可以自定义</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.15999999999999992em" columnalign="left" columnspacing="1em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mo>−</mo><mo stretchy="false">(</mo><msub><mi>σ</mi><mi>a</mi></msub><mo>+</mo><msub><mi>σ</mi><mi>s</mi></msub><mo stretchy="false">)</mo><mi>s</mi></mrow></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="false"><mrow><mi>L</mi><mo stretchy="false">(</mo><mi>s</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>e</mi><mrow><mo>−</mo><msub><mi>σ</mi><mi>t</mi></msub><mi>s</mi></mrow></msup></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{array}{l}L(s) = e^{-(\sigma_a + \sigma_s) s}\\L(s) = e^{-\sigma_t s}\end{array}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.4480000000000004em;vertical-align:-0.9740000000000004em;"></span><span class="mord"><span class="mtable"><span class="arraycolsep" style="width:0.5em;"></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.474em;"><span style="top:-3.586em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8879999999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mopen mtight">(</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mbin mtight">+</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.16454285714285719em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">s</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mclose mtight">)</span><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span></span></span><span style="top:-2.3859999999999997em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">L</span><span class="mopen">(</span><span class="mord mathnormal">s</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mord"><span class="mord mathnormal">e</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.771331em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">σ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.29634285714285713em;"><span style="top:-2.357em;margin-left:-0.03588em;margin-right:0.07142857142857144em;"><span class="pstrut" style="height:2.5em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.143em;"><span></span></span></span></span></span></span><span class="mord mathnormal mtight">s</span></span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9740000000000004em;"><span></span></span></span></span></span><span class="arraycolsep" style="width:0.5em;"></span></span></span></span></span></span></span></p>
<p>意思就是说越深的地方透过越少</p>
<p><img src="Untitled%202.png" alt="Untitled" /></p>
<p>散射类型也分很多种</p>
<ul>
<li><strong>米氏散射（Mie scattering）：</strong> 散射后看不出具体颜色，仅仅是黑白灰（反映光强大小）。是大气中粒子的直径与辐射的波长相当时发生的散射。这种散射主要由大气中的微粒，如烟、尘埃、小水滴及气溶胶等引起。<strong>米氏散射的散射强度与频率的二次方成正比，并且散射在光线向前方向比向后方向更强，方向性比较明显</strong></li>
<li>** 瑞利散射（Rayleigh scattering）：** 散射波长与入射波长相同；散射光强与波长的四次方成反比；散射光强按空间方向成哑铃形角分布。渲染天穹会用的到，另外关于偏振态变化：自然光入射时，各方向的散射光一般为部分偏振光，垂直入射光方向的散射光是线偏振光，沿入射光或其逆方向的散射光是自然光。</li>
</ul>
<blockquote>
<p>注：大于一定尺寸的是米氏散射，小于一定尺寸的是瑞利散射</p>
</blockquote>
<h2 id="phase-function"><a class="anchor" href="#phase-function">#</a> Phase Function</h2>
<p>光从进入 volume 到出来的时候，只有一小部分入射光向眼睛散射。多少取决于光线和视线方向之间的角度。而这个函数就是概率，算出有多少光线进入我们的眼睛，也就是说每次相机打 raymrach 做积分时候，这就是眼睛与 direction light 的 dot。因为定向光和相机摄像在积分时候是不会变的，所以只用算一次就行了，其中写成</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>p</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>θ</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_p(x, \theta)
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span></span></span></span></span></p>
<p>x 就是 phase，自定义的参数，在 Nubis 和 ue 都是两双 Phase Function 算出最终 Phase</p>
<p>其中在发生散射时候介质（Participating Media）有两种属性：</p>
<ul>
<li>
<p>各项同性（Isotropic）</p>
<p>就是各个方向发生的散射几率都是相同的，也就是生活中的漫反射，其公式很简单</p>
<figure class="highlight jsx"><figcaption data-lang="React JSX"><span>""</span></figcaption><table><tr><td data-num="1"></td><td><pre>float <span class="token function">IsotropicPhase</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">.</span>0f <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">.</span>0f <span class="token operator">*</span> <span class="token constant">PI</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure></li>
<li>
<p>各项异性（Anisotropic）</p>
<p>光线只朝着一个方向大量散射，例如云光照、头发</p>
<p><img src="Untitled%203.png" alt="Untitled" /></p>
<p>最常用之一 Phase 函数就是 HG 函数</p>
<p><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>p</mi></msub><mo stretchy="false">(</mo><mi>x</mi><mo separator="true">,</mo><mi>θ</mi><mo stretchy="false">)</mo><mo>=</mo><mfrac><mn>1</mn><mrow><mn>4</mn><mi>π</mi></mrow></mfrac><mfrac><mrow><mn>1</mn><mo>−</mo><msup><mi>g</mi><mn>2</mn></msup></mrow><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><msup><mi>g</mi><mn>2</mn></msup><mo>−</mo><mn>2</mn><mi>g</mi><mi>cos</mi><mo>⁡</mo><mi>θ</mi><msup><mo stretchy="false">)</mo><mfrac><mn>3</mn><mn>2</mn></mfrac></msup></mrow></mfrac><mi mathvariant="normal">.</mi></mrow><annotation encoding="application/x-tex">f_p(x,\theta) = \frac{1}{4 \pi} \frac{1 - g^2}{(1 + g^2 - 2 g \cos \theta)^{\frac{3}{2}}}.
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:-0.10764em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">x</span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:2.570678em;vertical-align:-1.07957em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.32144em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">4</span><span class="mord mathnormal" style="margin-right:0.03588em;">π</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.491108em;"><span style="top:-2.17043em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.740108em;"><span style="top:-2.9890000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord">2</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mop">cos</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">θ</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.93957em;"><span style="top:-3.3485500000000004em;margin-right:0.05em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight"><span class="mopen nulldelimiter sizing reset-size3 size6"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.8443142857142858em;"><span style="top:-2.656em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">2</span></span></span></span><span style="top:-3.2255000000000003em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line mtight" style="border-bottom-width:0.049em;"></span></span><span style="top:-3.384em;"><span class="pstrut" style="height:3em;"></span><span class="sizing reset-size3 size1 mtight"><span class="mord mtight"><span class="mord mtight">3</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.344em;"><span></span></span></span></span></span><span class="mclose nulldelimiter sizing reset-size3 size6"></span></span></span></span></span></span></span></span></span></span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.677em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:1.07957em;"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mord">.</span></span></span></span></span></p>
<figure class="highlight jsx"><figcaption data-lang="React JSX"><span>""</span></figcaption><table><tr><td data-num="1"></td><td><pre>float <span class="token function">HenyeyGreensteinPhase</span><span class="token punctuation">(</span><span class="token parameter">float <span class="token constant">G</span><span class="token punctuation">,</span> float CosTheta</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	float Numer <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span>0f <span class="token operator">-</span> <span class="token constant">G</span> <span class="token operator">*</span> <span class="token constant">G</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	float Denom <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span>0f <span class="token operator">+</span> <span class="token constant">G</span> <span class="token operator">*</span> <span class="token constant">G</span> <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">.</span>0f <span class="token operator">*</span> <span class="token constant">G</span> <span class="token operator">*</span> CosTheta<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">return</span> Numer <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">.</span>0f <span class="token operator">*</span> <span class="token constant">PI</span> <span class="token operator">*</span> Denom <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>Denom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre><span class="token comment">//HG 函数的近似 SchlickPhase</span></pre></td></tr><tr><td data-num="8"></td><td><pre>float <span class="token function">SchlickPhaseFromK</span><span class="token punctuation">(</span><span class="token parameter">float <span class="token constant">K</span><span class="token punctuation">,</span> float CosTheta</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	<span class="token keyword">const</span> float SchlickPhaseFactor <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span>0f <span class="token operator">+</span> <span class="token constant">K</span> <span class="token operator">*</span> CosTheta<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	<span class="token keyword">const</span> float PhaseValue <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">.</span>0f <span class="token operator">-</span> <span class="token constant">K</span> <span class="token operator">*</span> <span class="token constant">K</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">.</span>0f <span class="token operator">*</span> <span class="token constant">PI</span> <span class="token operator">*</span> SchlickPhaseFactor <span class="token operator">*</span> SchlickPhaseFactor<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	<span class="token keyword">return</span> PhaseValue<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>float <span class="token function">SchlickPhase</span><span class="token punctuation">(</span><span class="token parameter">float <span class="token constant">G</span><span class="token punctuation">,</span> float CosTheta</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">const</span> float <span class="token constant">K</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">.</span>55f <span class="token operator">*</span> <span class="token constant">G</span> <span class="token operator">-</span> <span class="token number">0</span><span class="token punctuation">.</span>55f <span class="token operator">*</span> <span class="token constant">G</span> <span class="token operator">*</span> <span class="token constant">G</span> <span class="token operator">*</span> <span class="token constant">G</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>	<span class="token keyword">return</span> <span class="token function">SchlickPhaseFromK</span><span class="token punctuation">(</span><span class="token constant">K</span><span class="token punctuation">,</span> CosTheta<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>这是个对 MieScattering 的一个模拟</p>
</li>
</ul>
<h1 id="代码"><a class="anchor" href="#代码">#</a> 代码</h1>
<p>最后求出</p>
<figure class="highlight glsl"><figcaption data-lang="GLSL"><span>""</span></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">float</span> <span class="token function">HenyeyGreensteinPhase</span><span class="token punctuation">(</span><span class="token keyword">float</span> G<span class="token punctuation">,</span> <span class="token keyword">float</span> CosTheta<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>	<span class="token keyword">float</span> Numer <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">-</span> G <span class="token operator">*</span> G<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>	<span class="token keyword">float</span> Denom <span class="token operator">=</span> <span class="token number">1.0f</span> <span class="token operator">+</span> G <span class="token operator">*</span> G <span class="token operator">+</span> <span class="token number">2.0f</span> <span class="token operator">*</span> G <span class="token operator">*</span> CosTheta<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>	<span class="token keyword">return</span> Numer <span class="token operator">/</span> <span class="token punctuation">(</span><span class="token number">4.0f</span> <span class="token operator">*</span> PI <span class="token operator">*</span> Denom <span class="token operator">*</span> <span class="token function">sqrt</span><span class="token punctuation">(</span>Denom<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="7"></td><td><pre></pre></td></tr><tr><td data-num="8"></td><td><pre><span class="token keyword">float</span> <span class="token function">SamplePhaseFunction</span><span class="token punctuation">(</span><span class="token keyword">in</span> <span class="token keyword">float</span> PhaseCosTheta<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> PhaseG<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> PhaseG2<span class="token punctuation">,</span> <span class="token keyword">in</span> <span class="token keyword">float</span> PhaseBlend<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>	PhaseG <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span>PhaseG<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.999f</span><span class="token punctuation">,</span> <span class="token number">0.999f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre>	PhaseG2 <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span>PhaseG2<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">0.999f</span><span class="token punctuation">,</span> <span class="token number">0.999f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="12"></td><td><pre>	PhaseBlend <span class="token operator">=</span> <span class="token function">clamp</span><span class="token punctuation">(</span>PhaseBlend<span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">1.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>	<span class="token keyword">float</span> MiePhaseValueLight0 <span class="token operator">=</span> <span class="token function">HenyeyGreensteinPhase</span><span class="token punctuation">(</span>PhaseG<span class="token punctuation">,</span> <span class="token operator">-</span>PhaseCosTheta<span class="token punctuation">)</span><span class="token punctuation">;</span>	</pre></td></tr><tr><td data-num="14"></td><td><pre>	<span class="token keyword">float</span> MiePhaseValueLight1 <span class="token operator">=</span> <span class="token function">HenyeyGreensteinPhase</span><span class="token punctuation">(</span>PhaseG2<span class="token punctuation">,</span> <span class="token operator">-</span>PhaseCosTheta<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>	<span class="token keyword">const</span> <span class="token keyword">float</span> Phase <span class="token operator">=</span> MiePhaseValueLight0 <span class="token operator">+</span> PhaseBlend <span class="token operator">*</span> <span class="token punctuation">(</span>MiePhaseValueLight1 <span class="token operator">-</span> MiePhaseValueLight0<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>	<span class="token keyword">return</span> Phase<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="18"></td><td><pre></pre></td></tr><tr><td data-num="19"></td><td><pre><span class="token keyword">const</span> float3 Light0Direction <span class="token operator">=</span> ResolvedView<span class="token punctuation">.</span>AtmosphereLightDirection<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>xyz<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token keyword">const</span> float3 Light1Illuminance <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre><span class="token keyword">const</span> float3 Light1IlluminanceFinal <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre><span class="token keyword">const</span> float3 Light1Direction <span class="token operator">=</span> <span class="token function">float3</span><span class="token punctuation">(</span><span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">,</span> <span class="token number">0.0f</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token keyword">const</span> float3 wi0 <span class="token operator">=</span> Light0Direction<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre><span class="token keyword">const</span> float3 wi1 <span class="token operator">=</span> Light1Direction<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre><span class="token keyword">const</span> float3 wo <span class="token operator">=</span> Raydir<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">float</span> Phase0CosTheta <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span>wi0<span class="token punctuation">,</span> wo<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">float</span> Phase0 <span class="token operator">=</span> <span class="token function">SamplePhaseFunction</span><span class="token punctuation">(</span>Phase0CosTheta<span class="token punctuation">,</span> PhaseG<span class="token punctuation">,</span> PhaseG2<span class="token punctuation">,</span> PhaseBlend<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="28"></td><td><pre><span class="token keyword">const</span> float3 SafePathSegmentTransmittance <span class="token operator">=</span> <span class="token function">exp</span><span class="token punctuation">(</span><span class="token operator">-</span>SafeExtinctionCoefficients <span class="token operator">*</span> dtMeters<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>float3 ScatteredLuminance <span class="token operator">=</span> TransmittanceToLight0 <span class="token operator">*</span> LightColor <span class="token operator">*</span> Phase0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>float3 LuminanceIntegral <span class="token operator">=</span> （ScatteredLuminance <span class="token operator">*</span>（<span class="token number">1</span> <span class="token operator">-</span> SafePathSegmentTransmittance<span class="token punctuation">)</span>） <span class="token operator">/</span> SafeExtinctionCoefficients<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>Luminance <span class="token operator">+=</span> LuminanceIntegral <span class="token punctuation">;</span></pre></td></tr></table></figure>