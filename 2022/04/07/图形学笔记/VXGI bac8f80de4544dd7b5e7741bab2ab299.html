<hr />
<p>title: VXGI<br />
date: 2022-04-07 12:00<br />
count: true<br />
tags:</p>
<ul>
<li>图形学笔记</li>
<li>渲染<br />
 category: 图形学笔记</li>
</ul>
<hr />
<h1 id="vxgi"><a class="anchor" href="#vxgi">#</a> VXGI</h1>
<p>Lumen 中的 VoxelLighting 和 VXGI 类似，使⽤是基于 3D Clipmap 的⽅式以节省存储空间。但 Lumen 的 VoxelLighting 中的每个 3D 纹素和 VXGI 中的 Voxel 并不相同 ——Lumen 的每个 3D 纹理表⽰的是<a href="https://www.notion.so/Ambient-Cube-074e81bf559f43b48fa72e7c2635eae7"> Ambient Cube</a> 某⼀个⽅向上的光照投射参数，实际上它所需要的 3D 纹素数量是其 Size 的 6 倍。这⼉可以看到 VoxelLighting 选择了和 MeshCards ⼏乎完全相同的结构 (六⾯体) 和基函数 (<a href="https://www.notion.so/Ambient-Cube-074e81bf559f43b48fa72e7c2635eae7">AmbientCube</a>)</p>
<p>VoxelLighting 默认使⽤ 4 级 3d Clipmap，存储的是以相机世界位置为中⼼点周围 200 米范围（可配置）的间接光照信息。 所有 MipLevels 和 Directions 均直接平铺在⼀张 3D 纹理中</p>
<ul>
<li>纹理⼤⼩为 [64 ,64 * MipLevels ,64 * Directions (6)]，除 X 轴等同于 Clipmap Size 外，在 Y 轴上平铺开了所有 MipLevels，在 Z 轴上平铺开了 Ambient Cube 的 6 个⽅向</li>
<li>各级 Mip 表达的距离以指数形式增⻓，第 0 级表⽰的范围是 [0,25 米]，第 3 级是 [100 米，200 米] , 反算其精度，可得第 0 级的精度为 25 米 * 2/64, 每个 Voxel 表达的场景空间⼤约在 0.78 米，类似可得第 3 级的精度为 3.125 米。</li>
</ul>
<p>对场景执行 Voxel Cone Tracing 的第一步是构建场景物体的稀疏<a href="https://www.notion.so/Octrees-89d53e6926b140738b5404d199d64367">体素八叉树</a>（Sparse Voxel Octree），UE5 使用了稀疏 HLOD 的网格距离场</p>
<p><img src="Untitled.png" alt="Untitled" /></p>
<p><img src="Untitled%201.png" alt="Untitled" /></p>
<p>一般使用了混合渲染管线，直接光（Primary ray）使用传统的光栅化获得，次级光则使用椎体追踪在体素椎体追踪之前，会预过滤几何体，然后像参合介质那样去追踪（可使用体积光线投射法）。而体素使用不透明场 + 入射辐射率来代表场景物体，这样可以使用四线性（Quadrilinearly）插值采样来模拟椎体射线覆盖的脚印</p>
<p><img src="Untitled%202.png" alt="越后面的用越大的MIP，权重也越小，类似GTAO和SSAO" /></p>
<p>越后面的用越大的 MIP，权重也越小，类似 GTAO 和 SSAO</p>
<p>Voxel 的渲染过程可分拆成 3 个 Pass：第一个 Pass 是光照，烘焙辐照度（反射阴影图，RSM）；第二个 Pass 是预过滤，使用稀疏八叉树下采样辐射率；第三个 Pass 是相机 Pass，收集每个可见片元（像素）的辐照度。（下图）</p>
<p><img src="Untitled%203.png" alt="Untitled" /></p>
<h1 id="实现voxel-gi"><a class="anchor" href="#实现voxel-gi">#</a> 实现 Voxel GI</h1>
<p>把物体中的颜色信息投影到 3d 纹理中，需要注意的是塞入到 3D 纹理中的颜色信息，并不只是物体本身的纹理颜色信息，还需要根据 ShadowMap 计算这点像素是否被遮挡，同时如果该物体有自发光，也需要将自发光计算在内。这样就构建了一个 3D 空间下每个像素下的颜色信息。</p>
<p><img src="Untitled%204.png" alt="Untitled" /></p>
<p>需要注意的是，由于一个面上包含的是前后两个面片，为了防止后面的像素被剔除，我们需要 Shader 的剔除关掉将其设置 Cull Off 即可</p>
