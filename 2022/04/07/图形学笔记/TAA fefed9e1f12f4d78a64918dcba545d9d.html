<hr />
<h2 id="title-taadate-2022-04-07-1200count-truetags-图形学笔记category-图形学笔记"><a class="anchor" href="#title-taadate-2022-04-07-1200count-truetags-图形学笔记category-图形学笔记">#</a> title: TAA<br />
date: 2022-04-07 12:00<br />
count: true<br />
tags: 图形学笔记<br />
 category: 图形学笔记</h2>
<h1 id="taa"><a class="anchor" href="#taa">#</a> TAA</h1>
<p>TAA 原理是通过 Motion Vector，找到上一帧的当前像素点的信息，然后混合，因为上一帧信息有很大概率还会出现在屏幕内。同时，对投影矩阵使用 noise 进行半个像素距离的偏移，使得每一帧的投影矩阵与上一帧都不一样，也就相当于混合了多次采样的结果，实现超级采样。</p>
<p>在采样的时候可以用周围 8 格，此时要是上一帧的投影矩阵 projection 到当前帧 uv 是在屏幕外面的话，可以用模糊</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">float3filter</span><span class="token punctuation">(</span>float3samples<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_TAA_UseBlurSharpenFilter</span></span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">float</span> k_blur0 <span class="token operator">=</span> <span class="token number">0.6915221</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">float</span> k_blur1 <span class="token operator">=</span> <span class="token number">0.07002799</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">float</span> k_blur2 <span class="token operator">=</span> <span class="token number">0.007091487</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    float3 blur_color <span class="token operator">=</span> <span class="token punctuation">(</span>samples<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> k_blur2 <span class="token operator">+</span></pre></td></tr><tr><td data-num="8"></td><td><pre>                        <span class="token punctuation">(</span>samples<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">*</span> k_blur1 <span class="token operator">+</span></pre></td></tr><tr><td data-num="9"></td><td><pre>                         samples<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> k_blur0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    float3 avg_color <span class="token operator">=</span> <span class="token punctuation">(</span>samples<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="11"></td><td><pre>                      <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="12"></td><td><pre>                      <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">+</span> samples<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    float3 sharp_color <span class="token operator">=</span> blur_color <span class="token operator">+</span> <span class="token punctuation">(</span>blur_color <span class="token operator">-</span> avg_color<span class="token punctuation">)</span> <span class="token operator">*</span> _TAA_Sharp <span class="token operator">*</span> <span class="token number">3</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">return</span> sharp_color<span class="token punctuation">;</span><span class="token comment">//clamp(sharp_color, 0, 65472.0);</span></pre></td></tr><tr><td data-num="15"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">else</span></span></pre></td></tr><tr><td data-num="16"></td><td><pre>    <span class="token keyword">return</span> samples<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><p>同时在采样历史帧的时候可以用 <code>Bicubic2DCatmullRom</code>  <a href="%E6%9B%B2%E7%BA%BF%200423a4fed5324b7aaf37482b6cc5a8b9.md">曲线</a></p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">float3sample_taa_tex</span><span class="token punctuation">(</span>float2uv<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    float2 samplePos <span class="token operator">=</span> uv <span class="token operator">*</span> _TAA_Texture_TexelSize<span class="token punctuation">.</span>zw<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    float2 tc1 <span class="token operator">=</span> <span class="token function">floor</span><span class="token punctuation">(</span>samplePos <span class="token operator">-</span> <span class="token number">0.5</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">0.5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre>    float2 f <span class="token operator">=</span> samplePos <span class="token operator">-</span> tc1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>    float2 f2 <span class="token operator">=</span> f <span class="token operator">*</span> f<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    float2 f3 <span class="token operator">=</span> f <span class="token operator">*</span> f2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">float</span> c <span class="token operator">=</span> _TAA_PrevSharp<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    float2 w0 <span class="token operator">=</span> <span class="token operator">-</span>c         <span class="token operator">*</span> f3 <span class="token operator">+</span>  <span class="token number">2.0</span> <span class="token operator">*</span> c         <span class="token operator">*</span> f2 <span class="token operator">-</span> c <span class="token operator">*</span> f<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>    float2 w1 <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">-</span> c<span class="token punctuation">)</span> <span class="token operator">*</span> f3 <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token number">3.0</span> <span class="token operator">-</span> c<span class="token punctuation">)</span>        <span class="token operator">*</span> f2          <span class="token operator">+</span> <span class="token number">1.0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    float2 w2 <span class="token operator">=</span> <span class="token operator">-</span><span class="token punctuation">(</span><span class="token number">2.0</span> <span class="token operator">-</span> c<span class="token punctuation">)</span> <span class="token operator">*</span> f3 <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token number">3.0</span> <span class="token operator">-</span> <span class="token number">2.0</span> <span class="token operator">*</span> c<span class="token punctuation">)</span>  <span class="token operator">*</span> f2 <span class="token operator">+</span> c <span class="token operator">*</span> f<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>    float2 w3 <span class="token operator">=</span> c          <span class="token operator">*</span> f3 <span class="token operator">-</span> c                <span class="token operator">*</span> f2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>    float2 w12 <span class="token operator">=</span> w1 <span class="token operator">+</span> w2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>    float2 tc0 <span class="token operator">=</span> _TAA_Texture_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token punctuation">(</span>tc1 <span class="token operator">-</span> <span class="token number">1.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>    float2 tc3 <span class="token operator">=</span> _TAA_Texture_TexelSize<span class="token punctuation">.</span>xy <span class="token operator">*</span> <span class="token punctuation">(</span>tc1 <span class="token operator">+</span> <span class="token number">2.0</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    float2 tc12 <span class="token operator">=</span> _TAA_Texture_TexelSize<span class="token punctuation">.</span>xy  <span class="token operator">*</span> <span class="token punctuation">(</span>tc1 <span class="token operator">+</span> w2 <span class="token operator">/</span> w12<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre></pre></td></tr><tr><td data-num="22"></td><td><pre>    float3 s0 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_TAA_Texture<span class="token punctuation">,</span> sampler_LinearClamp<span class="token punctuation">,</span> <span class="token function">float2</span><span class="token punctuation">(</span>tc12<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tc0<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>    float3 s1 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_TAA_Texture<span class="token punctuation">,</span> sampler_LinearClamp<span class="token punctuation">,</span> <span class="token function">float2</span><span class="token punctuation">(</span>tc0<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tc12<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    float3 s2 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_TAA_Texture<span class="token punctuation">,</span> sampler_LinearClamp<span class="token punctuation">,</span> <span class="token function">float2</span><span class="token punctuation">(</span>tc12<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tc12<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="25"></td><td><pre>    float3 s3 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_TAA_Texture<span class="token punctuation">,</span> sampler_LinearClamp<span class="token punctuation">,</span> <span class="token function">float2</span><span class="token punctuation">(</span>tc3<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tc0<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    float3 s4 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_TAA_Texture<span class="token punctuation">,</span> sampler_LinearClamp<span class="token punctuation">,</span> <span class="token function">float2</span><span class="token punctuation">(</span>tc12<span class="token punctuation">.</span>x<span class="token punctuation">,</span> tc3<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre></pre></td></tr><tr><td data-num="28"></td><td><pre>    <span class="token keyword">float</span> cw0 <span class="token operator">=</span> <span class="token punctuation">(</span>w12<span class="token punctuation">.</span>x <span class="token operator">*</span> w0<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="29"></td><td><pre>    <span class="token keyword">float</span> cw1 <span class="token operator">=</span> <span class="token punctuation">(</span>w0<span class="token punctuation">.</span>x <span class="token operator">*</span> w12<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="30"></td><td><pre>    <span class="token keyword">float</span> cw2 <span class="token operator">=</span> <span class="token punctuation">(</span>w12<span class="token punctuation">.</span>x <span class="token operator">*</span> w12<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    <span class="token keyword">float</span> cw3 <span class="token operator">=</span> <span class="token punctuation">(</span>w3<span class="token punctuation">.</span>x <span class="token operator">*</span> w12<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    <span class="token keyword">float</span> cw4 <span class="token operator">=</span> <span class="token punctuation">(</span>w12<span class="token punctuation">.</span>x <span class="token operator">*</span>  w3<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre></pre></td></tr><tr><td data-num="34"></td><td><pre>    float3 min_color <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>s0<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre>    min_color <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>min_color<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>s3<span class="token punctuation">,</span> s4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="36"></td><td><pre></pre></td></tr><tr><td data-num="37"></td><td><pre>    float3 max_color <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>s0<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>s1<span class="token punctuation">,</span> s2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="38"></td><td><pre>    max_color <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>max_color<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>s3<span class="token punctuation">,</span> s4<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="39"></td><td><pre></pre></td></tr><tr><td data-num="40"></td><td><pre>    s0 <span class="token operator">*=</span> cw0<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre>    s1 <span class="token operator">*=</span> cw1<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="42"></td><td><pre>    s2 <span class="token operator">*=</span> cw2<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    s3 <span class="token operator">*=</span> cw3<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>    s4 <span class="token operator">*=</span> cw4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre></pre></td></tr><tr><td data-num="46"></td><td><pre>    float3 historyFiltered <span class="token operator">=</span> s0 <span class="token operator">+</span> s1 <span class="token operator">+</span> s2 <span class="token operator">+</span> s3 <span class="token operator">+</span> s4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token keyword">float</span> weightSum <span class="token operator">=</span> cw0 <span class="token operator">+</span> cw1 <span class="token operator">+</span> cw2 <span class="token operator">+</span> cw3 <span class="token operator">+</span> cw4<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="48"></td><td><pre></pre></td></tr><tr><td data-num="49"></td><td><pre>    float3 filteredVal <span class="token operator">=</span> historyFiltered <span class="token operator">*</span> <span class="token function">rcp</span><span class="token punctuation">(</span>weightSum<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="50"></td><td><pre></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">return</span> <span class="token function">clamp</span><span class="token punctuation">(</span>filteredVal<span class="token punctuation">,</span> min_color<span class="token punctuation">,</span> max_color<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr></table></figure><h1 id="varianceclipping"><a class="anchor" href="#varianceclipping">#</a> VarianceClipping</h1>
<p>用周围 9 个像素的平均颜色求出当前像素颜色 max/min 像素，把历史帧限制在像素里面可以防止鬼影出现</p>
<figure class="highlight c"><figcaption data-lang="c"></figcaption><table><tr><td data-num="1"></td><td><pre>float3 m1 <span class="token operator">=</span> color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="2"></td><td><pre>          <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="3"></td><td><pre>          <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>float3 m2 <span class="token operator">=</span> color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="5"></td><td><pre>          <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span></pre></td></tr><tr><td data-num="6"></td><td><pre>          <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">+</span> color<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">*</span> color<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="7"></td><td><pre>float3 mu <span class="token operator">=</span> m1 <span class="token operator">/</span> <span class="token number">9</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>float3 sigma <span class="token operator">=</span> <span class="token function">sqrt</span><span class="token punctuation">(</span><span class="token function">abs</span><span class="token punctuation">(</span>m2 <span class="token operator">/</span> <span class="token number">9</span> <span class="token operator">-</span> mu <span class="token operator">*</span> mu<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 求平方差</span></pre></td></tr><tr><td data-num="9"></td><td><pre>min_color <span class="token operator">=</span> mu <span class="token operator">-</span> <span class="token number">1.5</span> <span class="token operator">*</span> sigma<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>max_color <span class="token operator">=</span> mu <span class="token operator">+</span> <span class="token number">1.5</span> <span class="token operator">*</span> sigma<span class="token punctuation">;</span></pre></td></tr></table></figure><p>也可以用单个像素 clipping，与 motion vector 关联，越大 offset 越远</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token keyword">void</span> <span class="token function">minmax_4tap</span><span class="token punctuation">(</span>float2uv<span class="token punctuation">,</span>float2mv<span class="token punctuation">,</span> <span class="token keyword">float</span> depth<span class="token punctuation">,</span> outfloat3min_color<span class="token punctuation">,</span> outfloat3max_color<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token keyword">const</span> <span class="token keyword">float</span> _SubpixelThreshold <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">float</span> _GatherBase <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    <span class="token keyword">const</span> <span class="token keyword">float</span> _GatherSubpixelMotion <span class="token operator">=</span> <span class="token number">0.1666</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>float2texel_vel <span class="token operator">=</span> mv <span class="token operator">/</span> _SourceTex_TexelSize<span class="token punctuation">.</span>xy<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    <span class="token keyword">float</span> texel_vel_mag <span class="token operator">=</span> <span class="token function">length</span><span class="token punctuation">(</span>texel_vel<span class="token punctuation">)</span> <span class="token operator">*</span> depth<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    <span class="token keyword">float</span> k_subpixel_motion <span class="token operator">=</span> <span class="token function">saturate</span><span class="token punctuation">(</span>_SubpixelThreshold <span class="token operator">/</span> <span class="token punctuation">(</span>FLT_EPS <span class="token operator">+</span> texel_vel_mag<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">float</span> k_min_max_support <span class="token operator">=</span> _GatherBase <span class="token operator">+</span> _GatherSubpixelMotion <span class="token operator">*</span> k_subpixel_motion<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>float2ss_offset01 <span class="token operator">=</span> k_min_max_support <span class="token operator">*</span><span class="token function">float2</span><span class="token punctuation">(</span><span class="token operator">-</span>_SourceTex_TexelSize<span class="token punctuation">.</span>x<span class="token punctuation">,</span> _SourceTex_TexelSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="13"></td><td><pre>float2ss_offset11 <span class="token operator">=</span> k_min_max_support <span class="token operator">*</span><span class="token function">float2</span><span class="token punctuation">(</span>_SourceTex_TexelSize<span class="token punctuation">.</span>x<span class="token punctuation">,</span> _SourceTex_TexelSize<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>float3c00 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_SourceTex<span class="token punctuation">,</span>sampler_LinearClamp<span class="token punctuation">,</span> uv <span class="token operator">-</span> ss_offset11<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>float3c10 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_SourceTex<span class="token punctuation">,</span>sampler_LinearClamp<span class="token punctuation">,</span> uv <span class="token operator">-</span> ss_offset01<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre>float3c01 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_SourceTex<span class="token punctuation">,</span>sampler_LinearClamp<span class="token punctuation">,</span> uv <span class="token operator">+</span> ss_offset01<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="17"></td><td><pre>float3c11 <span class="token operator">=</span> <span class="token function">SAMPLE_TEXTURE2D_X</span><span class="token punctuation">(</span>_SourceTex<span class="token punctuation">,</span>sampler_LinearClamp<span class="token punctuation">,</span> uv <span class="token operator">+</span> ss_offset11<span class="token punctuation">)</span><span class="token punctuation">.</span>rgb<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">if</span> <span class="token expression">_TAA_UseYCoCgSpace</span></span></pre></td></tr><tr><td data-num="19"></td><td><pre>    c00 <span class="token operator">=</span> <span class="token function">RGBToYCoCg</span><span class="token punctuation">(</span>c00<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre>    c10 <span class="token operator">=</span> <span class="token function">RGBToYCoCg</span><span class="token punctuation">(</span>c10<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    c01 <span class="token operator">=</span> <span class="token function">RGBToYCoCg</span><span class="token punctuation">(</span>c01<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    c11 <span class="token operator">=</span> <span class="token function">RGBToYCoCg</span><span class="token punctuation">(</span>c11<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span></pre></td></tr><tr><td data-num="24"></td><td><pre></pre></td></tr><tr><td data-num="25"></td><td><pre>    min_color <span class="token operator">=</span> <span class="token function">min</span><span class="token punctuation">(</span>c00<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>c10<span class="token punctuation">,</span> <span class="token function">min</span><span class="token punctuation">(</span>c01<span class="token punctuation">,</span> c11<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="26"></td><td><pre>    max_color <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>c00<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>c10<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>c01<span class="token punctuation">,</span> c11<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="aabbclip"><a class="anchor" href="#aabbclip">#</a> AABBClip</h1>
<p>利用刚刚得出的 Max/Min 求出 aabb 然后把颜色 clip 在里面</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">float3clip_color</span><span class="token punctuation">(</span>float3min_color<span class="token punctuation">,</span>float3max_color<span class="token punctuation">,</span>float3color<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre></pre></td></tr><tr><td data-num="4"></td><td><pre>    float3 p_clip <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max_color <span class="token operator">+</span> min_color<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>    float3 e_clip <span class="token operator">=</span> <span class="token number">0.5</span> <span class="token operator">*</span> <span class="token punctuation">(</span>max_color <span class="token operator">-</span> min_color<span class="token punctuation">)</span> <span class="token operator">+</span> FLT_EPS<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>    float3 v_clip <span class="token operator">=</span> color <span class="token operator">-</span> p_clip<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>    float3 v_unit <span class="token operator">=</span> v_clip <span class="token operator">/</span> e_clip<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre>    float3 a_unit <span class="token operator">=</span> <span class="token function">abs</span><span class="token punctuation">(</span>v_unit<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="10"></td><td><pre>    <span class="token keyword">float</span> ma_unit <span class="token operator">=</span> <span class="token function">max</span><span class="token punctuation">(</span>a_unit<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token function">max</span><span class="token punctuation">(</span>a_unit<span class="token punctuation">.</span>y<span class="token punctuation">,</span> a_unit<span class="token punctuation">.</span>z<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="11"></td><td><pre></pre></td></tr><tr><td data-num="12"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ma_unit <span class="token operator">></span> <span class="token number">1.0</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="13"></td><td><pre>        <span class="token keyword">return</span> p_clip <span class="token operator">+</span> v_clip <span class="token operator">/</span> ma_unit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>    <span class="token keyword">else</span></pre></td></tr><tr><td data-num="15"></td><td><pre>        <span class="token keyword">return</span> color<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure><h1 id="ycocg"><a class="anchor" href="#ycocg">#</a> YCoCg</h1>
<p>YCoCg 色彩模型是通过将关联的 RGB 色彩空间简单转换为亮度值（表示为 Y）和称为色度绿色（Cg）和色度橙色（Co）的两个色度值形成的色彩空间。 它支持视频和图像压缩设计，例如 H.264 / MPEG-4 AVC，HEVC，JPEG XR 和 Dirac，因为它计算简单，具有良好的变换编码增益，并且可以无损地转换 RGB 和 RGB 比其他颜色模型需要的位数少。</p>
<p>属性 YCoCg 色彩模型优于 YCbCr 色彩模型的优点是更简单快速的计算，更好的颜色平面解相关以提高压缩性能，以及完全无损的可逆性。</p>
<p>再 TAA 中 AABB 有时会在 RGB 空间上产生一个很大矩形区域，从而在某些情况下 clamp 得到历史像素偏差过大。一个更好的方法是使用沿亮度方向的 OBB 作为约束范围，这可以通过将像素色彩转换到 YCoCg 色彩空间下使用 AABB 来实现。</p>
<p><img src="Untitled.png" alt="Untitled" /></p>
<p><img src="Untitled%201.png" alt="Untitled" /></p>
<p>在 UE 会乘四倍，可能是为了避免小数出现</p>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">float3RGBToYCoCg</span><span class="token punctuation">(</span>float3RGB <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="3"></td><td><pre>   <span class="token keyword">float</span> Y  <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span> RGB<span class="token punctuation">,</span><span class="token function">float3</span><span class="token punctuation">(</span>  <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span>  <span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="4"></td><td><pre>   <span class="token keyword">float</span> Co <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span> RGB<span class="token punctuation">,</span><span class="token function">float3</span><span class="token punctuation">(</span>  <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">2</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="5"></td><td><pre>   <span class="token keyword">float</span> Cg <span class="token operator">=</span> <span class="token function">dot</span><span class="token punctuation">(</span> RGB<span class="token punctuation">,</span><span class="token function">float3</span><span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token punctuation">)</span> <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="6"></td><td><pre></pre></td></tr><tr><td data-num="7"></td><td><pre>float3YCoCg <span class="token operator">=</span><span class="token function">float3</span><span class="token punctuation">(</span> Y<span class="token punctuation">,</span> Co<span class="token punctuation">,</span> Cg <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="8"></td><td><pre>   <span class="token keyword">return</span> YCoCg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="9"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="10"></td><td><pre></pre></td></tr><tr><td data-num="11"></td><td><pre><span class="token function">float3YCoCgToRGB</span><span class="token punctuation">(</span>float3YCoCg <span class="token punctuation">)</span></pre></td></tr><tr><td data-num="12"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="13"></td><td><pre><span class="token keyword">float</span> Y  <span class="token operator">=</span> YCoCg<span class="token punctuation">.</span>x <span class="token operator">*</span> <span class="token number">0.25</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="14"></td><td><pre>   <span class="token keyword">float</span> Co <span class="token operator">=</span> YCoCg<span class="token punctuation">.</span>y <span class="token operator">*</span> <span class="token number">0.25</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="15"></td><td><pre>   <span class="token keyword">float</span> Cg <span class="token operator">=</span> YCoCg<span class="token punctuation">.</span>z <span class="token operator">*</span> <span class="token number">0.25</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="16"></td><td><pre></pre></td></tr><tr><td data-num="17"></td><td><pre>   <span class="token keyword">float</span> R <span class="token operator">=</span> Y <span class="token operator">+</span> Co <span class="token operator">-</span> Cg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="18"></td><td><pre>   <span class="token keyword">float</span> G <span class="token operator">=</span> Y <span class="token operator">+</span> Cg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="19"></td><td><pre>   <span class="token keyword">float</span> B <span class="token operator">=</span> Y <span class="token operator">-</span> Co <span class="token operator">-</span> Cg<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="20"></td><td><pre></pre></td></tr><tr><td data-num="21"></td><td><pre>float3RGB <span class="token operator">=</span><span class="token function">float3</span><span class="token punctuation">(</span> R<span class="token punctuation">,</span> G<span class="token punctuation">,</span> B <span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="22"></td><td><pre>   <span class="token keyword">return</span> RGB<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="23"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr></table></figure>