<!DOCTYPE html><html lang="ch"><head><link rel="stylesheet" href="/css/bilicard.css"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="夏猫" href="http://example.com/rss.xml"><link rel="alternate" type="application/atom+xml" title="夏猫" href="http://example.com/atom.xml"><link rel="alternate" type="application/json" title="夏猫" href="http://example.com/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><meta name="keywords" content="图形学笔记,渲染"><link rel="canonical" href="http://example.com/2022/04/19/Nanite/"><meta name="description" content="# Nanite   基于 Mesh Shader 的 Pipeline，Cluster 剔除成为了顶点处理阶段的一部分，减少没必要的 Vertex Buffer Load&#x2F;Store Nanite 把实现分成两个过程三个部分: 预处理过程：在模型导入或者在引擎中修改模型设置时处理，把高模预处理成一簇簇的三角形簇，建立分层分页结构用于渲染和加载  把模型分成 Cluster, 类似 Meshsha"><meta property="og:type" content="article"><meta property="og:title" content="Nanite"><meta property="og:url" content="http://example.com/2022/04/19/Nanite/index.html"><meta property="og:site_name" content="夏猫"><meta property="og:description" content="# Nanite   基于 Mesh Shader 的 Pipeline，Cluster 剔除成为了顶点处理阶段的一部分，减少没必要的 Vertex Buffer Load&#x2F;Store Nanite 把实现分成两个过程三个部分: 预处理过程：在模型导入或者在引擎中修改模型设置时处理，把高模预处理成一簇簇的三角形簇，建立分层分页结构用于渲染和加载  把模型分成 Cluster, 类似 Meshsha"><meta property="og:locale"><meta property="og:image" content="http://example.com/2022/04/19/Nanite/Untitled.png"><meta property="og:image" content="http://example.com/2022/04/19/Nanite/Untitled%201.png"><meta property="og:image" content="http://example.com/2022/04/19/Nanite/Untitled%202.png"><meta property="og:image" content="http://example.com/2022/04/19/Nanite/Untitled%203.png"><meta property="og:image" content="http://example.com/2022/04/19/Nanite/Untitled%204.png"><meta property="og:image" content="http://example.com/2022/04/19/Nanite/Untitled%205.png"><meta property="og:image" content="http://example.com/2022/04/19/Nanite/Untitled%206.png"><meta property="og:image" content="http://example.com/2022/04/19/Nanite/Untitled%207.png"><meta property="article:published_time" content="2022-04-19T04:00:00.000Z"><meta property="article:modified_time" content="2022-12-31T12:42:27.000Z"><meta property="article:author" content="Natsuneko"><meta property="article:tag" content="图形学笔记"><meta property="article:tag" content="渲染"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="http://example.com/2022/04/19/Nanite/Untitled.png"><meta name="twitter:creator" content="@natsunekosan"><title>Nanite - 图形学笔记 | Natsu neko = 夏猫 = 嵐です！</title><meta name="generator" content="Hexo 6.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="cat"><div class="body"></div><div class="head"><div class="face"></div></div><div class="foot"><div class="tummy-end"></div><div class="bottom"></div><div class="legs left"></div><div class="legs right"></div></div><div class="paw"><div class="hands left"></div><div class="hands right"></div></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">Nanite</h1><div class="meta"><span class="item" title="创建时间：2022-04-19 12:00:00"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">发表于</span> <time itemprop="dateCreated datePublished" datetime="2022-04-19T12:00:00+08:00">2022-04-19</time> </span><span class="item" title="本文字数"><span class="icon"><i class="ic i-pen"></i> </span><span class="text">本文字数</span> <span>5.6k</span> <span class="text">字</span> </span><span class="item" title="阅读时长"><span class="icon"><i class="ic i-clock"></i> </span><span class="text">阅读时长</span> <span>5 分钟</span></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="切换导航栏"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">Natsu neko</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-9m2q98.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-gp8y37.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-57jll5.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-6owo1x.png"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/172424_1695456632.jpg"></li><li class="item" data-background-image="https://github.com/Natsuneko3/wallpaperLibrary/raw/main/wallhaven-d65v63.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">首页</a></span><i class="ic i-angle-right"></i> <span class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/" itemprop="item" rel="index" title="分类于 图形学笔记"><span itemprop="name">图形学笔记</span></a><meta itemprop="position" content="1"></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="ch"><link itemprop="mainEntityOfPage" href="http://example.com/2022/04/19/Nanite/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="Natsuneko"><meta itemprop="description" content="嵐です！, 主要分享关于 ue 或者 TA 的知识，也或者分享点自己想写的东西，作品什么的"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="夏猫"></span><div class="body md" itemprop="articleBody"><h1 id="nanite"><a class="anchor" href="#nanite">#</a> Nanite</h1><p><img data-src="Untitled.png" alt="Untitled"></p><p><img data-src="Untitled%201.png" alt="基于Mesh Shader的Pipeline，Cluster剔除成为了顶点处理阶段的一部分，减少没必要的Vertex Buffer Load/Store"></p><p>基于 Mesh Shader 的 Pipeline，Cluster 剔除成为了顶点处理阶段的一部分，减少没必要的 Vertex Buffer Load/Store</p><p>Nanite 把实现分成两个过程三个部分: <em>预处理过程：在模型导入或者在引擎中修改模型设置时处理，把高模预处理成一簇簇的三角形簇，建立分层分页结构用于渲染和加载</em></p><p><img data-src="Untitled%202.png" alt="Untitled"></p><p>把模型分成 Cluster, 类似 Meshshader 中的 Meshlet。划分在拓扑空间中邻近的 Cluster，是为了提高访问数据时 Cache 命中率。Cluster 分割使用 Metis 库把模型的顶点数据进一步切分为更细粒度的<strong> Cluster</strong>（或者叫做<strong> Meshlet</strong>），让每个 Cluster 的粒度能够更好地适应 Vertex Processing 阶段的 Cache 大小，并以 Cluster 为单位进行各类剔除（<strong>Frustum Culling，Occulsion Culling，Backface Culling</strong>）已经逐渐成为了复杂场景优化的最佳实践，</p><h2 id="primtive数据"><a class="anchor" href="#primtive数据">#</a> <strong>Primtive 数据</strong></h2><p>Nanite 资源的 Primitive 数据都使用 StructureBuffer 存在于 GPU Memory 中，这就为后续的剔除、合批等操作提供了 GPU Driven 式的便利。</p><h2 id="cull"><a class="anchor" href="#cull">#</a> <strong>Cull</strong></h2><p>Nanite 的 Cull 在是 GPU Driven 的，在 CS 中执行的，它分为两大块： 一是 Primitive Instance 级，为每个模型执行 FrustumCull/HZB Cull 二是内部 BVH 树及 Cluster 级，分层的为 BVH 进行剔除，在一直相交的情形下会下降到 Cluster Boundary，注意到目前的 Nanite Cluster 剔除并没有剔除面积很小的三角形，也没有做背面剔除。 Cull 的同时它还会做一件事：标记该三角形走软件光栅化还是走硬件光栅化 —— 只有面积小于给定值的三角形才会走软件光栅化</p><h2 id="光栅化rasterization"><a class="anchor" href="#光栅化rasterization">#</a> <strong>光栅化 (Rasterization)</strong></h2><p>在剔除结束之后，每个 Cluster 会根据其屏幕空间的大小送至不同的光栅器，<strong>大三角形和非 Nanite Mesh 仍然基于硬件光栅化，小三角形基于 Compute Shader 写成的软光栅化</strong>。Nanite 的 Visibility Buffer 为一张 R32G32_UINT 的贴图 (8 Bytes/Pixel)，其中 R 通道的 0~6 bit 存储 Triangle ID，7~31 bit 存储 Cluster ID，G 通道存储 32 bit 深度。</p><p>整个软光栅化的逻辑比较简单：基于扫描线算法，每个 Cluster 启动一个单独的 Compute Shader，在 Compute Shader 初始阶段计算并缓存所有 Clip Space Vertex Position 到 shared memory，而后 CS 中的每个线程读取对应三角形的 Index Buffer 和变换后的 Vertex Position，根据 Vertex Position 计算出三角形的边，执行背面剔除和小三角形（小于一个像素）剔除，然后利用原子操作完成 Z-Test，并将数据写进 Visibility Buffer。</p><h1 id="软光栅化是否有机会打败硬光栅化"><a class="anchor" href="#软光栅化是否有机会打败硬光栅化">#</a> <strong>软光栅化是否有机会打败硬光栅化？</strong></h1><p><strong>传统光栅化硬件设计之初，设想的输入三角形大小是远大于一个像素的</strong>。基于这样的设想，硬件光栅化的过程通常是<strong>层次式的</strong>。以 N 卡的光栅器为例，一个三角形通常会经历两个阶段的光栅化：<strong>Coarse Raster</strong> 和<strong> Fine Raster</strong>，前者以一个三角形作为输入，以 8x8 像素为一个块，将三角形光栅化为若干块（你也可以理解成在尺寸为原始 FrameBuffer 1/8*1/8 大小的 FrameBuffer 上做了一次粗光栅化）。在这个阶段，借由低分辨率的 Z-Buffer，被遮挡的块会被整个剔除，N 卡上称之为<strong> Z Cull</strong>；在 Coarse Raster 之后，通过 Z Cull 的块会被送到下一阶段做 Fine Raster，最终生成用于着色计算的像素。在 Fine Raster 阶段，有我们熟悉的<strong> Early Z</strong>。由于 mip-map 采样的计算需要，我们必须知道每个像素相邻像素的信息，并利用采样 UV 的差分作为 mip-map 采样层级的计算依据。为此，Fine Raster 最终输出的并不是一个个像素，而是 2x2 的小像素块（<strong>Pixel Quad</strong>）。</p><p>对于接近像素大小的三角形来说，硬件光栅化的浪费就很明显了：首先，Coarse Raster 阶段几乎是无用的，因为这些三角形通常都是小于 8x8 的，对于那些狭长的三角形，这种情况更糟糕，因为一个三角形往往横跨多个块，而 Coarse Raster 不但无法剔除这些块，还会增加额外的计算负担；另外，对于大三角形来说，基于 Pixel Quad 的 Fine Raster 阶段只会在三角形边缘生成少量无用的像素，相较于整个三角形的面积，这只是很少的一部分；但对于小三角形来说，<strong>Pixel Quad 最坏会生成四倍于三角形面积的像素数</strong>，并且这些像素也包含在 pixel shader 的执行阶段，使得 warp 中有效的像素大大减少。</p><p><img data-src="Untitled%203.png" alt="Untitled"></p><p>每次渲染小三角形会形成很多像素的浪费在像素级小三角形这一特定前提下，<strong>软光栅化（基于 Compute Shader）的确有机会打败硬光栅化</strong>。这也正是 Nanite 的核心优化之一，这一优化使得 UE5 在小三角形光栅化的效率上<strong>提升了 3 倍</strong>。</p><h1 id="ue5-nanite-流程"><a class="anchor" href="#ue5-nanite-流程">#</a> UE5 nanite 流程</h1><p>它的核心思想可以简单拆解为两大部分：<strong>顶点处理的优化</strong>和<strong>像素处理的优化</strong>。<strong>其中顶点处理的优化主要是 GPU Driven Pipeline 的思想；像素处理的优化，是在 Visibility Buffer 思想的基础上，结合软光栅化完成的</strong></p><p><img data-src="Untitled%204.png" alt="Untitled"></p><p>每个 Nanite Mesh 在预处理阶段，会被切成若干 Cluster，每个 Cluster 包含 128 个三角形，其实是一个图的切分（graph partition）。整个 Mesh 以<strong> BVH（Bounding Volume Hierarchy）<strong>的形式组织成树状结构，每个叶节点代表一个 Cluster。剔除分两步，包含了</strong>视锥剔除</strong>和<strong>基于 HZB 的遮挡剔除</strong>。其中 Instance Cull 以 Mesh 为单位，通过 Instance Cull 的 Mesh 会将其 BVH 的根节点送到 Persistent Cull 阶段进行层次式的剔除</p><h1 id="如何把persistent-cull阶段的剔除任务数量映射到compute-shader的线程数量"><a class="anchor" href="#如何把persistent-cull阶段的剔除任务数量映射到compute-shader的线程数量">#</a> <strong>如何把 Persistent Cull 阶段的剔除任务数量映射到 Compute Shader 的线程数量</strong>？</h1><p>最简单的方法是<strong>给每棵 BVH 树一个单独的线程，也就是一个线程负责一个 Nanite Mesh</strong>。但由于每个 Mesh 的复杂度不同，其 BVH 树的节点数、深度差异很大，这样的安排会导致每个线程的任务处理时长大不相同，线程间互相等待，最终导致并行性很差；<strong>那么能否给每个需要处理的 BVH 节点分配一个单独的线程呢</strong>？这当然是最理想的情形，但实际上我们无法在剔除前预先知道会有多少个 BVH 节点被处理，因为整个剔除是层次式的、动态的。Nanite 解决这个问题的思路是：设置固定数量的线程，每个线程通过一个全局的 FIFO 任务队列去取 BVH 节点进行剔除，若该节点通过了剔除，则把该节点的所有子节点也放进任务队列尾部，然后继续循环从全局队列中取新的节点，直到整个队列为空且不再产生新的节点</p><p><img data-src="Untitled%205.png" alt="Untitled"></p><h1 id="emit-targets"><a class="anchor" href="#emit-targets">#</a> <strong><strong>Emit Targets</strong></strong></h1><p>为了保证数据结构尽量紧凑，减少读写带宽，所有软光栅化需要的数据都存进了一张 Visibility Buffer，但是为了与场景中基于硬件光栅化生成的像素混合，我们最终还是需要将 Visibility Buffer 中的额外信息写入到统一的 Depth/Stencil Buffer 以及 Motion Vector Buffer 当中。这个阶段通常由几个全屏 Pass 组成</p><h2 id="1emit-scene-depthstencilnanite-maskvelocity-buffer"><a class="anchor" href="#1emit-scene-depthstencilnanite-maskvelocity-buffer">#</a> （1）<strong>Emit Scene Depth/Stencil/Nanite Mask/Velocity Buffer</strong></h2><p>这一步根据最终场景需要的 RenderTarget 数据，最多输出四个 Buffer，其中 Nanite Mask 用 0/1 表示当前像素是普通 Mesh 还是 Nanite Mesh（根据 Visibility Buffer 对应位置的 ClusterID 得到），对于 Nanite Mesh Pixel，将 Visibility Buffer 中的 Depth 由 UINT 转为 float 写入 Scene Depth Buffer，并根据 Nanite Mesh 是否接受贴花，将贴花对应的 Stencil Value 写入 Scene Stencil Buffer，并根据上一帧位置计算当前像素的 Motion Vector 写入 Velocity Buffer，非 Nanite Mesh 则直接 discard 跳过。</p><p>（2）<strong>Emit Material Depth</strong><br>这一步将生成一张 Material ID Buffer，稍有不同的是，它并未存储在一张 UINT 类型的贴图，而是将 UINT 类型的 Material ID 转为 float 存储在一张格式为 D32S8 的 Depth/Stencil Target 上（稍后我们会解释这么做的理由），理论上最多支持 2^32 种材质（实际上只有 14 bits 用于存储 Material ID），而 Nanite Mask 会被写入 Stencil Buffer 中。</p><h1 id="classify-materials-emit-g-buffer"><a class="anchor" href="#classify-materials-emit-g-buffer">#</a> <strong><strong>Classify Materials &amp;&amp; Emit G-Buffer</strong></strong></h1><p><strong>Nanite 的材质 Shader 是在 Screen Space 执行的，Nanite 在 Base Pass 绘制阶段并不是每种材质一个全屏 Pass，而是将屏幕空间分成若干 8x8 的块，比如屏幕大小为 800x600，则每种材质绘制时生成 100x75 个块，每块对应屏幕位置。为了能够整块地剔除，在 Emit Targets 之后，Nanite 会启动一个 CS 用于统计每个块内包含的 Material ID 的种类。由于 Material ID 对应的 Depth 值预先是经过排序的，所以这个 CS 会统计每个 8x8 的块内 Material Depth 的最大最小值作为 Material ID Range 存储在一张 R32G32_UINT 的贴图中</strong></p><p><img data-src="Untitled%206.png" alt="Untitled"></p><p>有了这张图之后，每种材质在其 VS 阶段，都会根据自身块的位置去采样这张贴图对应位置的 Material ID Range，若当前材质的 Material ID 处于 Range 内，则继续执行材质的 PS；否则表示当前块内没有像素使用该材质，则整块可以剔除，此时只需将 VS 的顶点位置设置为 NaN，GPU 就会将对应的三角形剔除。由于通常一个块内的材质种类不会太多，这种方法可以有效地减少不必要的 overdraw。实际上通过分块分类减少材质分支</p><p>整个 Base Pass 分为两部分，首先绘制非 Nanite Mesh 的 G-Buffer，这部分仍然在 Object Space 执行，和 UE4 的逻辑一致；之后按照上述流程绘制 Nanite Mesh 的 G-Buffer，其中材质需要的额外 VS 信息（UV，Normal，Vertex Color 等）通过像素的 Cluster ID 和 Triangle ID 索引到相应的 Vertex Position，并变换到 Clip Space，根据 Clip Space Vertex Position 和当前像素的深度值求出当前像素的重心坐标以及 Clip Space Position 的梯度（DDX/DDY），将重心坐标和梯度代入各类 Vertex Attributes 中插值即可得到所有的 Vertex Attributes 及其梯度（梯度可用于计算采样的 Mip Map 层级）。</p><p><img data-src="Untitled%207.png" alt="Untitled"></p><p><span class="exturl" data-url="aHR0cDovL3d3dy5nYW1lbG9vay5jb20uY24vMjAyMS8xMC80NTYzNjk=">Epic 王祢：详解虚幻引擎 5 核心技术 Nanite</span></p><p>Nanite LOD</p><p>我们把 LOD 0 的 Mesh 拿过来，生成了一组 LOD 0 的 Cluster，那这组 Cluster 我们会再用 graph partition 的条件，把一组 Cluster，比如 64 个、32 个或者更少的 Cluster 合并成一个 Cluster Group。背后的条件也是一样的，面积尽可能均匀、边界尽可能少，在减面的时候，其实是在这个 Group 里进行。我先简单举例，如右图所示（实际划分不止是 4 个），比如现在有一些 Cluster、假设它只有 4 个面，我把这 4 个 Cluster 并成了一个 Group，这是 LOD 0 的。那我要降一级 LOD 的时候怎么做呢？我先把这些 Cluster 的边界全解开，把一个 Group 看成一个大的 Cluster，这时我锁住这个 Cluster 的边界，去对半地减面。之后再以 128 个面分成一个 Cluster 时，它 Cluster 的数量刚好也是减半，就变成了两个 Cluster，所以生成了新的 Cluster Group 里减完面的就是两个 Cluster。大家可以看到，这两个 Cluster 除了 Group 的外边界跟上面保持一致，内部的边界其实是没有关系的。</p><div class="tags"><a href="/tags/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/" rel="tag"><i class="ic i-tag"></i> 图形学笔记</a> <a href="/tags/%E6%B8%B2%E6%9F%93/" rel="tag"><i class="ic i-tag"></i> 渲染</a></div></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">更新于</span> <time title="修改时间：2022-12-31 20:42:27" itemprop="dateModified" datetime="2022-12-31T20:42:27+08:00">2022-12-31</time></span></div><div class="reward"><button><i class="ic i-heartbeat"></i> 赞赏</button><p>请我喝[茶]~(￣▽￣)~*</p><div id="qr"><div><img data-src="/images/wechatpay.png" alt="Natsuneko 微信支付"><p>微信支付</p></div><div><img data-src="/images/alipay.png" alt="Natsuneko 支付宝"><p>支付宝</p></div><div><img data-src="/images/paypal.png" alt="Natsuneko 贝宝"><p>贝宝</p></div></div></div><div id="copyright"><ul><li class="author"><strong>本文作者： </strong>Natsuneko <i class="ic i-at"><em>@</em></i>夏猫</li><li class="link"><strong>本文链接：</strong> <a href="http://example.com/2022/04/19/Nanite/" title="Nanite">http://example.com/2022/04/19/Nanite/</a></li><li class="license"><strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2022/04/10/ue%E6%BA%90%E7%A0%81/UnifomBuffer/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3&#x2F;wallpaperLibrary&#x2F;raw&#x2F;main&#x2F;wallhaven-4g62qe.jpg" title="UnifomBuffer"><span class="type">上一篇</span> <span class="category"><i class="ic i-flag"></i> UE 源码笔记</span><h3>UnifomBuffer</h3></a></div><div class="item right"><a href="/2022/04/19/Lumen/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3&#x2F;wallpaperLibrary&#x2F;raw&#x2F;main&#x2F;wallhaven-1pgwov.jpg" title="Lumen"><span class="type">下一篇</span> <span class="category"><i class="ic i-flag"></i> 图形学笔记</span><h3>Lumen</h3></a></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="文章目录"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nanite"><span class="toc-number">1.</span> <span class="toc-text">Nanite</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#primtive%E6%95%B0%E6%8D%AE"><span class="toc-number">1.1.</span> <span class="toc-text">Primtive 数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#cull"><span class="toc-number">1.2.</span> <span class="toc-text">Cull</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%89%E6%A0%85%E5%8C%96rasterization"><span class="toc-number">1.3.</span> <span class="toc-text">光栅化 (Rasterization)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%BD%AF%E5%85%89%E6%A0%85%E5%8C%96%E6%98%AF%E5%90%A6%E6%9C%89%E6%9C%BA%E4%BC%9A%E6%89%93%E8%B4%A5%E7%A1%AC%E5%85%89%E6%A0%85%E5%8C%96"><span class="toc-number">2.</span> <span class="toc-text">软光栅化是否有机会打败硬光栅化？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ue5-nanite-%E6%B5%81%E7%A8%8B"><span class="toc-number">3.</span> <span class="toc-text">UE5 nanite 流程</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E6%8A%8Apersistent-cull%E9%98%B6%E6%AE%B5%E7%9A%84%E5%89%94%E9%99%A4%E4%BB%BB%E5%8A%A1%E6%95%B0%E9%87%8F%E6%98%A0%E5%B0%84%E5%88%B0compute-shader%E7%9A%84%E7%BA%BF%E7%A8%8B%E6%95%B0%E9%87%8F"><span class="toc-number">4.</span> <span class="toc-text">如何把 Persistent Cull 阶段的剔除任务数量映射到 Compute Shader 的线程数量？</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#emit-targets"><span class="toc-number">5.</span> <span class="toc-text">Emit Targets</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1emit-scene-depthstencilnanite-maskvelocity-buffer"><span class="toc-number">5.1.</span> <span class="toc-text">（1）Emit Scene Depth&#x2F;Stencil&#x2F;Nanite Mask&#x2F;Velocity Buffer</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#classify-materials-emit-g-buffer"><span class="toc-number">6.</span> <span class="toc-text">Classify Materials &amp;&amp; Emit G-Buffer</span></a></li></ol></div><div class="related panel pjax" data-title="系列文章"><ul><li><a href="/2022/04/07/GPU/" rel="bookmark" title="GPU">GPU</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/" rel="bookmark" title="图形学笔记目录">图形学笔记目录</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/Ambient%20Cube%20074e81bf559f43b48fa72e7c2635eae7/" rel="bookmark" title="Ambient Cube">Ambient Cube</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/BRDF%E6%96%B9%E7%A8%8B%2070512469e005449dab1f3eb91452f787/" rel="bookmark" title="BRDF方程">BRDF方程</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/Compute%20shader%20ce8a4f41e18845b0ac4fb1978f28869f/" rel="bookmark" title="Compute shader">Compute shader</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/GTAO%20cdb7d5c086e44d4ca1489b7b64c373a0/" rel="bookmark" title="GTAO">GTAO</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/HZB%20(Hierarchical%20Z-Buffer)%2084e7171093be454f8b86d1d03ac2310b/" rel="bookmark" title="HZB (Hierarchical Z-Buffer)">HZB (Hierarchical Z-Buffer)</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/HLSL%E8%AF%AD%E8%A8%80%E5%9F%BA%E7%A1%80/" rel="bookmark" title="HLSL语言基础">HLSL语言基础</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/MVP%E7%9F%A9%E9%98%B5%20474772934c4146dcb4cddcb94c7b48a4/" rel="bookmark" title="MVP矩阵">MVP矩阵</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/SH%E6%B1%82%E8%B0%90%E5%87%BD%E6%95%B0%E4%B8%8E%E7%AB%8B%E4%BD%93%E8%A7%92%20ea839e75f76f4b02bfaf515e79810f44/" rel="bookmark" title="SH求谐函数与立体角">SH求谐函数与立体角</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/TAA%20fefed9e1f12f4d78a64918dcba545d9d/" rel="bookmark" title="TAA">TAA</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/VXGI%20bac8f80de4544dd7b5e7741bab2ab299/" rel="bookmark" title="VXGI">VXGI</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/Visibility%20Buffer%20328fe9588ec5451faf76588581bfd0b1/" rel="bookmark" title="Visibility Buffer">Visibility Buffer</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/%E5%9B%BE%E7%89%87%E5%8E%8B%E7%BC%A9%E7%AE%97%E6%B3%95%2037b07de836514407b210f68c9a91c0ec/" rel="bookmark" title="图片压缩算法">图片压缩算法</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/%E6%97%8B%E8%BD%AC%E7%9B%B8%E5%85%B3%204cf01f6c2d37404ba421f52a0d30f0cc/" rel="bookmark" title="旋转相关">旋转相关</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/%E6%9D%82%E9%A1%B9%205b7a33b443b4469482b32406094b9773/" rel="bookmark" title="图形学笔记杂项">图形学笔记杂项</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/%E7%A9%BA%E9%97%B4%E7%BB%93%E6%9E%84%E5%88%92%E5%88%86%204c6a1b50e90841d3b3e7ce5734c4210b/" rel="bookmark" title="空间结构划分">空间结构划分</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/%E8%8C%83%E6%95%B0%207e8460db51a840648bc0541f33b4af00/" rel="bookmark" title="范数">范数</a></li><li><a href="/2022/04/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/%E8%BF%AD%E4%BB%A3%E6%B3%95%20d5c9fb20c6d746ceadd94b6beb306cd3/" rel="bookmark" title="迭代法">迭代法</a></li><li><a href="/2022/04/10/ue%E6%BA%90%E7%A0%81/shader%E4%BC%98%E5%8C%96/" rel="bookmark" title="shader优化">shader优化</a></li><li><a href="/2022/04/10/ue%E6%BA%90%E7%A0%81/shader%E7%BC%96%E8%AF%91/" rel="bookmark" title="shader编译">shader编译</a></li><li><a href="/2022/04/19/Lumen/" rel="bookmark" title="Lumen">Lumen</a></li><li class="active"><a href="/2022/04/19/Nanite/" rel="bookmark" title="Nanite">Nanite</a></li><li><a href="/2022/10/19/%E6%B7%B1%E5%85%A5GPU%E5%92%8C%E6%B8%B2%E6%9F%93%E4%BC%98%E5%8C%96%EF%BC%88%E5%9F%BA%E7%A1%80%E7%AF%87%EF%BC%89%20d4b709561b4345e4b120236c4dd265f4/" rel="bookmark" title="深入GPU和渲染优化（基础篇）">深入GPU和渲染优化（基础篇）</a></li><li><a href="/2023/01/09/ShadowMap/" rel="bookmark" title="ShadowMap">ShadowMap</a></li><li><a href="/2023/02/03/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/VirtualTexture/" rel="bookmark" title="VirtualTexture">VirtualTexture</a></li><li><a href="/2023/02/07/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/%E8%96%84%E8%86%9C%E5%B9%B2%E6%B6%89/" rel="bookmark" title="薄膜干涉">薄膜干涉</a></li><li><a href="/2023/02/17/%E7%BE%8E%E6%9C%AF%E8%B4%B4%E5%9B%BE%E8%B5%84%E6%BA%90PBR%E6%B5%81%E7%A8%8B/" rel="bookmark" title="美术贴图资源PBR流程">美术贴图资源PBR流程</a></li><li><a href="/2023/09/23/%E5%9B%BE%E5%BD%A2%E5%AD%A6%E7%AC%94%E8%AE%B0/VolumeRendering/" rel="bookmark" title="Volume Rendering">Volume Rendering</a></li></ul></div><div class="overview panel" data-title="站点概览"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="Natsuneko" data-src="/images/avatar.jpg"><p class="name" itemprop="name">Natsuneko</p><div class="description" itemprop="description">主要分享关于 ue 或者 TA 的知识，也或者分享点自己想写的东西，作品什么的</div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">66</span> <span class="name">文章</span></a></div><div class="item categories"><a href="/categories/"><span class="count">6</span> <span class="name">分类</span></a></div><div class="item tags"><a href="/tags/"><span class="count">17</span> <span class="name">标签</span></a></div></nav><div class="social"><span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL05hdHN1bmVrbzM=" title="https:&#x2F;&#x2F;github.com&#x2F;Natsuneko3"><i class="ic i-github"></i></span> <span class="exturl item twitter" data-url="aHR0cHM6Ly90d2l0dGVyLmNvbS9uYXRzdW5la29zYW4=" title="https:&#x2F;&#x2F;twitter.com&#x2F;natsunekosan"><i class="ic i-twitter"></i></span> <span class="exturl item zhihu" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3Blb3BsZS9OYXRzdW5la28=" title="https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;Natsuneko"><i class="ic i-zhihu"></i></span> <span class="exturl item weibo" data-url="aHR0cHM6Ly93ZWliby5jb20veW91cm5hbWU=" title="https:&#x2F;&#x2F;weibo.com&#x2F;yourname"><i class="ic i-weibo"></i></span></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>首页</a></li><li class="item"><a href="/about/" rel="section"><i class="ic i-user"></i>关于</a></li><li class="item dropdown"><a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a><ul class="submenu"><li class="item"><a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a></li><li class="item"><a href="/categories/" rel="section"><i class="ic i-th"></i>分类</a></li><li class="item"><a href="/tags/" rel="section"><i class="ic i-tags"></i>标签</a></li></ul></li><li class="item"><span class="exturl" data-url="aHR0cHM6Ly93d3cucmVhbHRpbWUueHl6Lw=="><i class="ic i-heart"></i>friends</span></li></ul></div></div></div><ul id="quick"><li class="prev pjax"><a href="/2022/04/10/ue%E6%BA%90%E7%A0%81/UnifomBuffer/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"><a href="/2022/04/19/Lumen/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"></div><div class="status"><div class="copyright">&copy; 2020 – <span itemprop="copyrightYear">2023</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">Natsuneko @ Natsu neko</span></div><div class="count"><span class="post-meta-item-icon"><i class="ic i-chart-area"></i> </span><span title="站点总字数">339k 字</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="ic i-coffee"></i> </span><span title="站点阅读时长">5:08</span></div><div class="powered-by">基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2022/04/19/Nanite/",favicon:{show:"（●´3｀●）感觉还不错把",hide:"____________________________________"},search:{placeholder:"文章搜索",empty:"关于 「 ${query} 」，什么也没搜到",stats:"${time} ms 内找到 ${hits} 条结果"},valine:!0,fancybox:!0,copyright:'复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',ignores:[function(_){return _.includes("#")},function(_){return new RegExp(LOCAL.path+"$").test(_)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>